# Prometheus Configuration for Yii3 Invoice Application
# This configuration scrapes metrics from the application, node_exporter, and windows_exporter

global:
  scrape_interval: 15s          # Set the scrape interval to every 15 seconds
  evaluation_interval: 15s      # Evaluate rules every 15 seconds
  scrape_timeout: 10s           # Timeout for individual scrapes
  
  # Attach these labels to any time series or alerts when communicating with
  # external systems (federation, remote storage, Alertmanager).
  external_labels:
    monitor: 'yii3-invoice-monitor'
    environment: 'production'   # Change to 'development', 'staging', etc.
    application: 'yii3-invoice'

# Alertmanager configuration (optional)
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - "alertmanager:9093"  # Uncomment and configure if using Alertmanager

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  - "rules/yii3-invoice-rules.yml"
  # - "rules/node-exporter-rules.yml"
  # - "rules/windows-exporter-rules.yml"

# A scrape configuration containing exactly one endpoint to scrape
scrape_configs:
  # Yii3 Invoice Application Metrics
  - job_name: 'yii3-invoice-app'
    static_configs:
      - targets: ['localhost:8080']        # Your application URL and port
    metrics_path: '/metrics'               # Prometheus metrics endpoint
    scrape_interval: 15s
    scrape_timeout: 10s
    honor_labels: false
    scheme: http
    
    # Add labels to identify the application
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'yii3-invoice-app'
      - source_labels: []
        target_label: job
        replacement: 'yii3-invoice-app'
        
    # Metric relabeling (optional)
    metric_relabel_configs:
      # Add application version label if available
      - source_labels: [__name__]
        regex: 'yii3_invoice_application_build_info'
        target_label: app_version
        replacement: '1.0.0'

  # Node Exporter (Linux/Unix System Metrics)
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['localhost:9100']        # Node exporter default port
    scrape_interval: 15s
    scrape_timeout: 10s
    
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'yii3-invoice-server'

  # Windows Exporter (Windows System Metrics) - Only enable on Windows servers
  - job_name: 'windows-exporter'
    static_configs:
      - targets: ['localhost:9182']        # Windows exporter default port
    scrape_interval: 15s
    scrape_timeout: 10s
    
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'yii3-invoice-windows-server'
        
    # Only collect relevant Windows metrics
    metric_relabel_configs:
      # Keep only essential Windows metrics to reduce storage
      - source_labels: [__name__]
        regex: 'windows_(cpu|memory|logical_disk|net|os|process|service|iis)_.*'
        action: keep
      - source_labels: [__name__]
        regex: 'go_.*|promhttp_.*'
        action: drop

  # Prometheus Self-Monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 5s
    metrics_path: '/metrics'
    
  # Optional: MySQL/Database Exporter (if using separate DB monitoring)
  # - job_name: 'mysql-exporter'
  #   static_configs:
  #     - targets: ['localhost:9104']
  #   scrape_interval: 15s

  # Optional: Redis Exporter (if using Redis)
  # - job_name: 'redis-exporter'
  #   static_configs:
  #     - targets: ['localhost:9121']
  #   scrape_interval: 15s

  # Optional: Apache/Nginx Exporter (if using separate web server monitoring)
  # - job_name: 'apache-exporter'
  #   static_configs:
  #     - targets: ['localhost:9117']
  #   scrape_interval: 15s

# Storage configuration
storage:
  tsdb:
    path: /prometheus/data
    retention.time: 30d           # Keep data for 30 days
    retention.size: 10GB          # Limit storage to 10GB
    wal-compression: true         # Enable WAL compression

# Remote write configuration (optional, for long-term storage)
# remote_write:
#   - url: "https://your-remote-storage-endpoint/api/v1/write"
#     queue_config:
#       max_samples_per_send: 1000
#       max_shards: 200
#       capacity: 2500

# Web configuration
web:
  # Listen address for Prometheus web UI
  listen-address: '0.0.0.0:9090'
  
  # External URL (if accessed through reverse proxy)
  # external-url: 'https://prometheus.yourdomain.com/'
  
  # Enable admin API (be careful in production)
  enable-admin-api: false
  
  # Console template and library paths
  console.templates: 'consoles'
  console.libraries: 'console_libraries'
  
  # CORS settings (if needed for Grafana integration)
  web.cors.origin: '.*'

# Log configuration
log:
  level: info                    # Options: debug, info, warn, error
  format: logfmt                 # Options: logfmt, json