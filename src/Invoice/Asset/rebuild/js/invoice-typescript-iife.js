"use strict";var InvoiceApp=(()=>{var $=Object.defineProperty;var te=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var ie=Object.prototype.hasOwnProperty;var oe=(a,t)=>{for(var e in t)$(a,e,{get:t[e],enumerable:!0})},se=(a,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of ne(t))!ie.call(a,i)&&i!==e&&$(a,i,{get:()=>t[i],enumerable:!(n=te(t,i))||n.enumerable});return a};var re=a=>se($({},"__esModule",{value:!0}),a);var fe={};oe(fe,{InvoiceApp:()=>H});function u(a){if(!a)return{};if(typeof a=="object"&&a!==null)return a;if(typeof a=="string")try{return JSON.parse(a)}catch{return{}}return{}}async function p(a,t,e={}){let n=a;if(t){let r=new URLSearchParams;Object.entries(t).forEach(([c,m])=>{Array.isArray(m)?m.forEach(d=>{d!=null&&r.append(`${c}[]`,String(d))}):m!=null&&r.append(c,String(m))});let l=a.includes("?")?"&":"?";n=`${a}${l}${r.toString()}`}let i={method:"GET",credentials:"same-origin",cache:"no-store",headers:{Accept:"application/json"},...e},o=await fetch(n,i);if(!o.ok)throw new Error(`Network response not ok: ${o.status}`);let s=await o.text();try{return JSON.parse(s)}catch{return s}}function g(a,t){try{if(!a)return null;if(typeof a.closest=="function")return a.closest(t);let e=a;for(;e;){if(e.matches&&e.matches(t))return e;e=e.parentElement}}catch(e){return console.warn("closestSafe error:",e),null}return null}function ae(a){return document.getElementById(a)}function K(a){return document.querySelector(a)}function w(a){return ae(a)?.value||""}var k=class{confirmButtonSelector=".create-credit-confirm";constructor(){this.initialize()}initialize(){document.addEventListener("click",this.handleClick.bind(this),!0)}async handleClick(t){let e=t.target;if(!(!e||e.id!=="create-credit-confirm")){t.preventDefault();try{await this.processCreateCredit()}catch(n){console.error("Create credit error:",n),alert(`Error: ${n instanceof Error?n.message:"Unknown error"}`)}}}async processCreateCredit(){let t=`${location.origin}/invoice/inv/create_credit_confirm`,e=K(this.confirmButtonSelector),n=new URL(location.href);e&&(e.innerHTML='<h6 class="text-center"><i class="fa fa-spin fa-spinner"></i></h6>');let o={inv_id:n.pathname.split("/").at(-1)||"",client_id:w("client_id"),inv_date_created:w("inv_date_created"),group_id:w("inv_group_id"),password:w("inv_password"),user_id:w("user_id")},s=await p(t,o),r=u(s);r.success===1?(e&&(e.innerHTML='<h2 class="text-center"><i class="bi bi-check2-square"></i></h2>'),r.flash_message&&alert(r.flash_message),location.href=n.href,location.reload()):(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>'),r.flash_message&&alert(r.flash_message),location.href=n.href,location.reload())}};function L(){window.location.reload()}function O(a,t){let n=new DOMParser().parseFromString(t,"text/html"),i=document.createDocumentFragment();Array.from(n.body.children).forEach(o=>i.appendChild(o)),a.innerHTML="",a.appendChild(i)}function M(){return new URL(location.href).pathname.split("/").at(-1)||""}function v(a){return document.getElementById(a)?.value||""}function y(a,t,e){t?(a.innerHTML='<h6 class="text-center"><i class="fa fa-spin fa-spinner"></i></h6>',a.disabled=!0):(a.innerHTML=e||'<h6 class="text-center"><i class="fa fa-check"></i></h6>',a.disabled=!1)}var I=class{constructor(){this.bindEventListeners(),this.initializeComponents()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0),document.addEventListener("input",this.handleInput.bind(this),!0),document.addEventListener("focus",this.handleFocus.bind(this),!0),document.addEventListener("click",this.handleClientNoteSave.bind(this),!0),document.addEventListener("click",this.handleQuoteTaxSubmit.bind(this),!0)}handleClick(t){let e=t.target,n=e.closest(".btn_delete_item");if(n){this.handleDeleteItem(n);return}let i=e.closest(".delete-items-confirm-quote");if(i){this.handleDeleteMultipleItems(i);return}if(e.closest(".btn_add_row_modal")){this.handleAddRowModal();return}if(e.closest(".btn_quote_item_add_row")){this.handleAddQuoteItemRow();return}if(e.closest(".btn_add_row")){this.handleAddGenericRow();return}if(e.closest(".quote_add_client")){this.handleAddClientModal();return}if(e.closest("#quote_create_confirm, .quote_create_confirm")){this.handleQuoteCreateConfirm();return}let m=e.closest("#quote_with_purchase_order_number_confirm, .quote_with_purchase_order_number_confirm");if(m){this.handleQuotePurchaseOrderConfirm(m);return}let d=e.closest("#quote_to_invoice_confirm, .quote_to_invoice_confirm");if(d){this.handleQuoteToInvoiceConfirm(d);return}let f=e.closest("#quote_to_so_confirm, .quote_to_so_confirm");if(f){this.handleQuoteToSalesOrderConfirm(f);return}let h=e.closest("#quote_to_quote_confirm, .quote_to_quote_confirm");if(h){this.handleQuoteToQuoteConfirm(h);return}this.handlePdfGeneration(e)}async handleDeleteItem(t){let e=t.getAttribute("data-id");if(!e){t.closest(".item")?.remove();return}try{let n=`${location.origin}/invoice/quote/delete_item/${encodeURIComponent(e)}`,i=await p(n,{id:e}),o=u(i);o.success===1?(location.reload(),t.closest(".item")?.remove(),alert("Deleted")):console.warn("delete_item failed",o)}catch(n){console.error("delete_item error",n),alert("An error occurred while deleting item. See console for details.")}}async handleDeleteMultipleItems(t){let e=t.innerHTML;y(t,!0);try{let n=document.querySelectorAll("input[name='item_ids[]']:checked"),i=Array.from(n).map(r=>parseInt(r.value,10)).filter(Boolean).toSorted((r,l)=>r-l),o=await p("/invoice/quoteitem/multiple",{item_ids:i}),s=u(o);s.success===1?(t.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>',location.reload()):(console.warn("quoteitem/multiple failed",s),y(t,!1,e))}catch(n){console.error("quoteitem/multiple error",n),y(t,!1,e),alert("An error occurred while deleting items. See console for details.")}}async handleAddRowModal(){let t=M(),e=`${location.origin}/invoice/quoteitem/add/${encodeURIComponent(t)}`,n=document.getElementById("modal-placeholder-quoteitem");if(n)try{n.innerHTML='<h2 class="text-center"><i class="fa fa-spin fa-spinner"></i></h2>';let o=await(await fetch(e,{cache:"no-store",credentials:"same-origin"})).text();O(n,o)}catch(i){console.error("Failed to load quoteitem modal",i)}}handleAddQuoteItemRow(){let t=document.getElementById("new_quote_item_row"),e=document.getElementById("item_table");if(t&&e){let n=t.cloneNode(!0);n.removeAttribute("id"),n.classList.add("item"),n.style.display="",e.appendChild(n)}}handleAddGenericRow(){let t=document.getElementById("new_row"),e=document.getElementById("item_table");if(t&&e){let n=t.cloneNode(!0);n.removeAttribute("id"),n.classList.add("item"),n.style.display="",e.appendChild(n)}}async handleAddClientModal(){let t=`${location.origin}/invoice/add-a-client`,e=document.getElementById("modal-placeholder-client");if(e)try{e.innerHTML='<h2 class="text-center"><i class="fa fa-spin fa-spinner"></i></h2>';let i=await(await fetch(t,{cache:"no-store",credentials:"same-origin"})).text();O(e,i)}catch(n){console.error("Failed to load add-a-client modal",n)}}async handleQuoteCreateConfirm(){let t=`${location.origin}/invoice/quote/create_confirm`,e=document.querySelector(".quote_create_confirm"),n=e?.innerHTML||"";e&&y(e,!0);try{let i={client_id:v("create_quote_client_id"),quote_group_id:v("quote_group_id"),quote_password:v("quote_password")},o=await p(t,i),s=u(o);s.success===1?(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),L()):s.success===0&&(e&&(e.innerHTML='<h6 class="text-center"><i class="fa fa-check"></i></h6>'),L(),s.message&&alert(s.message))}catch(i){console.error("create_confirm error",i),e&&y(e,!1,n),alert("An error occurred while creating quote. See console for details.")}}async handleQuotePurchaseOrderConfirm(t){let e=`${location.origin}/invoice/quote/approve`,n=document.querySelector(".quote_with_purchase_order_number_confirm")||t;n&&y(n,!0);try{let i={url_key:v("url_key"),client_po_number:v("quote_with_purchase_order_number"),client_po_person:v("quote_with_purchase_order_person")},o=await p(e,i);u(o).success===1&&(n&&(n.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),L())}catch(i){console.error("approve error",i),n&&y(n,!1),alert("An error occurred while approving quote. See console for details.")}}async handleQuoteToInvoiceConfirm(t){let e=`${location.origin}/invoice/quote/quote_to_invoice_confirm`,n=document.querySelector(".quote_to_invoice_confirm")||t,i=n?.innerHTML||"";n&&y(n,!0);try{let s={quote_id:M(),client_id:v("client_id"),group_id:v("group_id"),password:v("password")},r=await p(e,s),l=u(r);n&&(n.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),l.success&&l.redirect_url?window.location.href=l.redirect_url:l.success&&l.new_invoice_id?window.location.href=`${location.origin}/invoice/inv/view/${l.new_invoice_id}`:L(),l.flash_message&&alert(l.flash_message)}catch(o){console.error("quote_to_invoice_confirm error",o),n&&y(n,!1,i),alert("An error occurred while converting quote to invoice. See console for details.")}}async handleQuoteToSalesOrderConfirm(t){let e=`${location.origin}/invoice/quote/quote_to_so_confirm`,n=document.querySelector(".quote_to_so_confirm")||t,i=n?.innerHTML||"";n&&y(n,!0);try{let s={quote_id:M(),client_id:v("client_id"),group_id:v("so_group_id"),po_number:v("po_number"),po_person:v("po_person"),password:v("password")},r=await p(e,s),l=u(r);n&&(n.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),l.success&&l.redirect_url?window.location.href=l.redirect_url:L(),l.flash_message&&alert(l.flash_message)}catch(o){console.error("quote_to_so_confirm error",o),n&&y(n,!1,i),alert("An error occurred while converting quote to SO. See console for details.")}}async handleQuoteToQuoteConfirm(t){let e=`${location.origin}/invoice/quote/quote_to_quote_confirm`,n=document.querySelector(".quote_to_quote_confirm")||t,i=n?.innerHTML||"";n&&y(n,!0);try{let s={quote_id:M(),client_id:v("create_quote_client_id"),user_id:v("user_id")},r=await p(e,s),l=u(r);l.success===1&&(n&&(n.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),L(),l.flash_message&&alert(l.flash_message))}catch(o){console.error("quote_to_quote_confirm error",o),n&&y(n,!1,i),alert("An error occurred while copying quote. See console for details.")}}handlePdfGeneration(t){if(t.closest("#quote_to_pdf_confirm_with_custom_fields")){let e=`${location.origin}/invoice/quote/pdf/1`;window.open(e,"_blank");return}if(t.closest("#quote_to_pdf_confirm_without_custom_fields")){let e=`${location.origin}/invoice/quote/pdf/0`;window.open(e,"_blank");return}}async handleClientNoteSave(t){if(!t.target.closest("#save_client_note"))return;let i=`${location.origin}/invoice/client/save_client_note`,o=`${location.origin}/invoice/client/load_client_notes`;try{let s={client_id:v("client_id"),client_note:v("client_note")},r=await p(i,s),l=u(r);if(l.success===1){document.querySelectorAll(".control-group").forEach(d=>{d.classList.remove("error")});let c=document.getElementById("client_note");c&&(c.value="");let m=document.getElementById("notes_list");if(m){let d=`${o}?client_id=${encodeURIComponent(s.client_id)}`,h=await(await fetch(d,{cache:"no-store",credentials:"same-origin"})).text();O(m,h)}}else document.querySelectorAll(".control-group").forEach(c=>{c.classList.remove("error")}),l.validation_errors&&Object.entries(l.validation_errors).forEach(([c,m])=>{let d=document.getElementById(c);d?.parentElement&&d.parentElement.classList.add("has-error")})}catch(s){console.error("save_client_note error",s),alert("Status: error An error occurred")}}async handleQuoteTaxSubmit(t){let n=t.target.closest("#quote_tax_submit");if(!n)return;let i=`${location.origin}/invoice/quote/save_quote_tax_rate`,o=document.querySelector(".quote_tax_submit")||n;o&&y(o,!0);try{let r={quote_id:M(),tax_rate_id:v("tax_rate_id"),include_item_tax:v("include_item_tax")},l=await p(i,r),c=u(l);L(),c.flash_message&&alert(c.flash_message)}catch(s){console.error("save_quote_tax_rate error",s),alert("An error occurred while saving quote tax rate. See console for details.")}}handleInput(t){let e=t.target;if(e.id==="quote_discount_amount"){let n=document.getElementById("quote_discount_percent");e.value.length>0?n&&(n.value="0.00",n.disabled=!0):n&&(n.disabled=!1)}if(e.id==="quote_discount_percent"){let n=document.getElementById("quote_discount_amount");e.value.length>0?n&&(n.value="0.00",n.disabled=!0):n&&(n.disabled=!1)}}handleFocus(t){let e=t.target;e.id==="datepicker"&&this.initializeDatepicker(e),e.classList?.contains("datepicker")&&this.initializeDatepicker(e),e.classList?.contains("taggable")&&(window.lastTaggableClicked=e)}initializeDatepicker(t){window.jQuery?.fn?.datepicker&&(t.id==="datepicker"?window.jQuery(t).datepicker({changeMonth:!0,changeYear:!0,showButtonPanel:!0,dateFormat:"dd-mm-yy"}):window.jQuery(t).datepicker({beforeShow:()=>{setTimeout(()=>{document.querySelectorAll(".datepicker").forEach(e=>{e.style.zIndex="9999"})},0)}}))}initializeComponents(){document.addEventListener("DOMContentLoaded",()=>{this.initializeTooltips(),this.initializeTagSelect()})}initializeTooltips(){typeof window.bootstrap?.Tooltip<"u"&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(t=>{try{new window.bootstrap.Tooltip(t)}catch{}})}initializeTagSelect(){document.querySelectorAll(".tag-select").forEach(t=>{t.addEventListener("change",n=>{let i=n.currentTarget;return window.lastTaggableClicked&&this.insertAtCaret(window.lastTaggableClicked.id,i.value),i._tomselect?.clear?i._tomselect.clear():i.tomselect?.clear?i.tomselect.clear():i.multiple?Array.from(i.options).toReversed().forEach(o=>{o.selected=!1}):i.value="",n.preventDefault(),!1})})}insertAtCaret(t,e){let n=document.getElementById(t);if(!n)return;let i=n.selectionStart||0,o=n.selectionEnd||0,s=n.value;n.value=s.substring(0,i)+e+s.substring(o),n.setSelectionRange(i+e.length,i+e.length),n.focus()}};function S(a){return document.getElementById(a)?.value||""}function le(){window.location.reload()}function x(a="h6",t="text-center",e="fa fa-spin fa-spinner"){let n=document.createElement(a);n.className=t;let i=document.createElement("i");return i.className=e,n.appendChild(i),n}function b(a,t,e){t?(a.textContent="",a.appendChild(x("h6","text-center","fa fa-spin fa-spinner")),a.disabled=!0):(a.textContent="",a.appendChild(x("h6","text-center","fa fa-check")),a.disabled=!1)}function X(a,t="h6",e="text-center",n="fa fa-spin fa-spinner"){a&&(a.textContent="",a.appendChild(x(t,e,n)))}var C=class{constructor(){this.bindEventListeners()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0),this.bindSpecificFormHandlers()}bindSpecificFormHandlers(){let t=(e,n)=>{let i=document.getElementById(e);i?i.addEventListener("submit",n.bind(this)):document.addEventListener("DOMContentLoaded",()=>{let o=document.getElementById(e);o&&o.addEventListener("submit",n.bind(this))})};t("QuoteForm",this.handleQuoteFormSubmit),t("InvForm",this.handleInvoiceFormSubmit)}handleClick(t){let e=t.target,n=e.closest("#client_create_confirm");if(n){this.handleClientCreateConfirm(n);return}let i=e.closest("#save_client_note_new");if(i){this.handleSaveClientNote(i);return}let o=e.closest(".client-note-delete-btn");if(o){this.handleDeleteClientNote(o);return}}async handleClientCreateConfirm(t){let e=`${location.origin}/invoice/client/create_confirm`,n=document.querySelector(".client_create_confirm")||t;n&&b(n,!0);try{let i={client_name:S("client_name"),client_surname:S("client_surname"),client_email:S("client_email")},o=await p(e,i),s=u(o);s.success===1?(n&&X(n,"h2","text-center","fa fa-check"),le()):(n&&b(n,!1),console.warn("create_confirm response",s))}catch(i){console.warn(i),n&&b(n,!1),alert("An error occurred while creating client. See console for details.")}}async handleSaveClientNote(t){let e=`${location.origin}/invoice/client/save_client_note_new`,n=`${location.origin}/invoice/client/load_client_notes`,i=document.querySelector(".save_client_note")||t,o=new URL(location.href);i&&b(i,!0);try{let s={client_id:S("client_id"),client_note:S("client_note")},r=await p(e,s),l=u(r);if(l.success===1){i&&X(i,"h2","text-center","fa fa-check");let c=document.getElementById("client_note");c&&(c.value="");let m=document.getElementById("notes_list");if(m){let d=`${n}?client_id=${encodeURIComponent(s.client_id)}`;try{let h=await(await fetch(d,{cache:"no-store",credentials:"same-origin"})).text();if(h&&!h.includes("<!DOCTYPE")&&!h.includes("<html")){m.textContent="";let E=new DOMParser;try{let T=E.parseFromString(h,"text/html");if(T&&T.body){let N=document.createDocumentFragment();for(;T.body.firstChild;)N.appendChild(T.body.firstChild);m.appendChild(N)}}catch(T){console.error("HTML parsing error:",T),m.textContent="Error loading notes"}}else{console.warn("Received full page HTML instead of notes fragment, reloading page"),window.location.reload();return}}catch(f){console.error("load_client_notes failed",f),window.location.reload();return}}setTimeout(()=>{i&&b(i,!1,'<h6 class="text-center"><i class="fa fa-save"></i></h6>')},1e3)}else this.clearValidationErrors(),l.validation_errors&&this.showValidationErrors(l.validation_errors),i&&b(i,!1)}catch(s){console.warn(s),i&&b(i,!1),alert("An error occurred while saving client note. See console for details.")}}async handleDeleteClientNote(t){let e=t.getAttribute("data-note-id");if(!e){console.error("No note ID found on delete button");return}if(!confirm("Are you sure you want to delete this note?"))return;let n=`${location.origin}/invoice/client/delete_client_note`,i=t.innerHTML;try{t.textContent="";let o=document.createElement("i");o.className="fa fa-spin fa-spinner",t.appendChild(o),t.disabled=!0;let s=await fetch(`${n}?note_id=${encodeURIComponent(e)}`,{method:"GET",credentials:"same-origin"});if(s.ok){let r=await s.json();if(r.success===1){let l=t.closest(".panel");l&&l.remove()}else t.innerHTML=i,t.disabled=!1,alert(r.message||"Failed to delete note. Please try again.")}else{let r=await s.text();console.error("Delete client note HTTP error:",{status:s.status,statusText:s.statusText,body:r.substring(0,500)}),t.innerHTML=i,t.disabled=!1,alert("Failed to delete note. Please try again.")}}catch(o){console.error("Delete client note error:",o),t.innerHTML=i,t.disabled=!1,alert("An error occurred while deleting the note. Please try again.")}}clearValidationErrors(){document.querySelectorAll(".control-group").forEach(t=>{t.classList.remove("error")})}showValidationErrors(t){Object.entries(t).forEach(([e,n])=>{let i=document.getElementById(e);i?.parentElement&&i.parentElement.classList.add("has-error")})}async handleQuoteFormSubmit(t){t.preventDefault();let e=t.target,n=e.querySelector('button[type="submit"]'),i=n?.innerHTML;if(n&&b(n,!0),n){n.textContent="";let s=document.createElement("i");s.className="fa fa-check",n.appendChild(s)}let o=document.getElementById("modal-add-quote")||document.getElementById("modal-add-client");if(o){let s=window.bootstrap?.Modal?.getInstance(o);s&&s.hide()}setTimeout(()=>{e.submit()},300)}async handleInvoiceFormSubmit(t){t.preventDefault();let e=t.target,n=e.querySelector('button[type="submit"]'),i=n?.innerHTML;if(n&&b(n,!0),n){n.textContent="";let s=document.createElement("i");s.className="fa fa-check",n.appendChild(s)}let o=document.getElementById("modal-add-inv")||document.getElementById("modal-add-client");if(o){let s=window.bootstrap?.Modal?.getInstance(o);s&&s.hide()}setTimeout(()=>{e.submit()},300)}};function q(a,t,e){t?(a.innerHTML='<h2 class="text-center"><i class="fa fa-spin fa-spinner"></i></h2>',a.disabled=!0):(a.innerHTML=e||'<h2 class="text-center"><i class="fa fa-check"></i></h2>',a.disabled=!1)}function _(a){return document.getElementById(a)?.value||""}var P=class{constructor(){this.bindEventListeners()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0),document.addEventListener("change",this.handleChange.bind(this),!0),this.initializeAllClientsCheck()}handleChange(t){let e=t.target,n=e.closest('[name="checkbox-selection-all"]');if(n){this.handleSelectAllCheckboxes(n.checked);return}if(e.closest("#user_all_clients")){this.handleAllClientsCheck();return}}handleClick(t){let e=t.target;if(g(e,"#btn-mark-as-sent")){this.handleMarkAsSent();return}if(g(e,"#btn-mark-sent-as-draft")){this.handleMarkSentAsDraft();return}let o=g(e,".create_recurring_confirm_multiple");if(o){this.handleCreateRecurringMultiple(o);return}let s=g(e,".delete-items-confirm-inv")||g(e,"#delete-items-confirm-inv");if(s){this.handleDeleteInvoiceItems(s);return}let r=g(e,".modal_copy_inv_multiple_confirm");if(r){this.handleCopyMultipleInvoices(r);return}let l=g(e,"#inv_to_inv_confirm")||g(e,".inv_to_inv_confirm");if(l){this.handleCopySingleInvoice(l);return}let c=g(e,"#inv_tax_submit");if(c){t.preventDefault(),this.handleAddInvoiceTax(c);return}if(g(e,"#inv_to_pdf_confirm_with_custom_fields")){this.handlePdfExport(!0);return}if(g(e,"#inv_to_pdf_confirm_without_custom_fields")){this.handlePdfExport(!1);return}if(g(e,"#inv_to_modal_pdf_confirm_with_custom_fields")){this.handleModalPdfView(!0);return}if(g(e,"#inv_to_modal_pdf_confirm_without_custom_fields")){this.handleModalPdfView(!1);return}if(g(e,"#inv_to_html_confirm_with_custom_fields")){this.handleHtmlExport(!0);return}if(g(e,"#inv_to_html_confirm_without_custom_fields")){this.handleHtmlExport(!1);return}if(g(e,"#btn_modal_payment_submit")){this.handlePaymentSubmit();return}if(g(e,".btn_add_row_modal")){this.handleAddRowModal();return}if(g(e,".btn_inv_item_add_row")){this.handleAddInvoiceItemRow();return}let J=g(e,".btn_delete_item");if(J){this.handleDeleteSingleItem(J);return}}getCheckedInvoiceIds(){let t=[],e=document.getElementById("table-invoice");return e&&e.querySelectorAll('input[type="checkbox"]:checked').forEach(i=>{i.id&&t.push(i.id)}),t}async handleMarkAsSent(){let t=document.getElementById("btn-mark-as-sent"),e=t?.innerHTML;t&&q(t,!0);try{let n=this.getCheckedInvoiceIds(),i=`${location.origin}/invoice/inv/mark_as_sent`,o=await p(i,{keylist:n});u(o).success===1?(t&&(t.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),window.location.reload()):(t&&(t.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>'),window.location.reload())}catch(n){console.error("mark_as_sent error",n),t&&e&&q(t,!1,e),alert("An error occurred. See console for details.")}}async handleMarkSentAsDraft(){let t=document.getElementById("btn-mark-sent-as-draft"),e=t?.innerHTML;t&&q(t,!0);try{let n=this.getCheckedInvoiceIds(),i=`${location.origin}/invoice/inv/mark_sent_as_draft`,o=await p(i,{keylist:n});u(o).success===1?(t&&(t.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),window.location.reload()):(t&&(t.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>'),window.location.reload())}catch(n){console.error("mark_sent_as_draft error",n),t&&e&&q(t,!1,e),alert("An error occurred. See console for details.")}}async handleCreateRecurringMultiple(t){let e=document.querySelector(".create_recurring_confirm_multiple")||t,n=e?.innerHTML;e&&(e.innerHTML='<h6 class="text-center"><i class="fa fa-spin fa-spinner"></i></h6>',e.disabled=!0);try{let i=this.getCheckedInvoiceIds();if(i.length===0){alert("Please select invoices to create recurring invoices."),e&&n&&(e.innerHTML=n,e.disabled=!1);return}let o={keylist:i,recur_frequency:_("recur_frequency"),recur_start_date:_("recur_start_date"),recur_end_date:_("recur_end_date")};if(!o.recur_frequency||!o.recur_start_date){alert("Please select frequency and start date."),e&&n&&(e.innerHTML=n,e.disabled=!1);return}let s=`${location.origin}/invoice/invrecurring/multiple`,r=await p(s,o),l=u(r);if(l.success===1)e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),this.closeModal("create-recurring-multiple"),setTimeout(()=>{window.location.reload()},500);else{e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>');let c=l.message||"Failed to create recurring invoices. Please try again.";alert(c),e&&n&&(e.innerHTML=n,e.disabled=!1)}}catch(i){console.error("invrecurring/multiple error",i),e&&n&&(e.innerHTML=n,e.disabled=!1),alert("An error occurred while creating recurring invoices. See console for details.")}}async handleCopyMultipleInvoices(t){let e=document.querySelector(".modal_copy_inv_multiple_confirm")||t,n=e?.innerHTML;e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-spin fa-spinner"></i></h2>',e.disabled=!0);try{let i=_("modal_created_date"),o=this.getCheckedInvoiceIds();if(o.length===0){alert("Please select invoices to copy."),e&&n&&(e.innerHTML=n,e.disabled=!1);return}let s={keylist:o,modal_created_date:i},r=`${location.origin}/invoice/inv/multiplecopy`,l=await p(r,s);u(l).success===1?(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),window.location.reload()):(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>'),window.location.reload())}catch(i){console.error("multiplecopy error",i),e&&n&&(e.innerHTML=n,e.disabled=!1),alert("An error occurred. See console for details.")}}async handleAddInvoiceTax(t){let e=document.getElementById("inv_tax_submit"),n=e?.innerHTML;e&&(e.innerHTML='<i class="fa fa-spin fa-spinner"></i>',e.disabled=!0);try{let s={inv_id:new URL(location.href).pathname.split("/").at(-1)||"",inv_tax_rate_id:_("inv_tax_rate_id"),include_inv_item_tax:_("include_inv_item_tax")},r=`${location.origin}/invoice/inv/save_inv_tax_rate`,l=await p(r,s);u(l).success===1?(e&&(e.innerHTML='<i class="fa fa-check"></i>'),this.closeModal("add-inv-tax"),setTimeout(()=>{window.location.reload()},500)):(e&&(e.innerHTML='<i class="fa fa-times"></i>'),alert("Failed to add invoice tax. Please try again."),e&&n&&(e.innerHTML=n,e.disabled=!1))}catch(i){console.error("invoice tax add error",i),e&&n&&(e.innerHTML=n,e.disabled=!1),alert("An error occurred while adding invoice tax. See console for details.")}}async handleCopySingleInvoice(t){let e=document.querySelector(".inv_to_inv_confirm")||t,n=e?.innerHTML;e&&(e.innerHTML='<h6 class="text-center"><i class="fa fa-spin fa-spinner"></i></h6>',e.disabled=!0);try{let s={inv_id:new URL(location.href).pathname.split("/").at(-1)||"",client_id:_("create_inv_client_id"),user_id:_("user_id")},r=`${location.origin}/invoice/inv/inv_to_inv_confirm`,l=await p(r,s),c=u(l);c.success===1?(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),c.new_invoice_id?window.location.href=`${location.origin}/invoice/inv/view/${c.new_invoice_id}`:window.location.reload()):(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>'),window.location.reload())}catch(i){console.error("inv_to_inv_confirm error",i),e&&n&&(e.innerHTML=n,e.disabled=!1),alert("An error occurred. See console for details.")}}async handleDeleteInvoiceItems(t){let e=document.querySelector(".delete-items-confirm-inv")||t,n=e?.innerHTML;e&&(e.innerHTML='<i class="fa fa-spin fa-spinner"></i>',e.disabled=!0);try{let i=[];document.querySelectorAll("input[name='item_ids[]']:checked").forEach(f=>{f.value&&i.push(f.value)});let r=new URL(location.href).pathname.split("/").at(-1)||"";if(i.length===0){alert("Please select items to delete."),e&&n&&(e.innerHTML=n,e.disabled=!1);return}let l={item_ids:i,inv_id:r},c=`${location.origin}/invoice/invitem/multiple`,m=await p(c,l);u(m).success===1?(e&&(e.innerHTML='<i class="fa fa-check"></i>'),this.closeModal("delete-items"),setTimeout(()=>{window.location.reload()},500)):(e&&(e.innerHTML='<i class="fa fa-times"></i>'),alert("Failed to delete items. Please try again."),e&&n&&(e.innerHTML=n,e.disabled=!1))}catch(i){console.error("delete items error",i),e&&n&&(e.innerHTML=n,e.disabled=!1),alert("An error occurred while deleting items. See console for details.")}}handlePdfExport(t){let e=t?"1":"0",n=`${location.origin}/invoice/inv/pdf/${e}`;window.open(n,"_blank")}handleModalPdfView(t){let e=t?"1":"0",n=`${location.origin}/invoice/inv/pdf/${e}`,i=document.getElementById("modal-view-inv-pdf");i&&(i.src=n);try{if(typeof window.bootstrap?.Modal<"u"){let o=document.getElementById("modal-layout-modal-pdf-inv");o&&new window.bootstrap.Modal(o).show()}}catch(o){console.warn("Failed to open PDF modal:",o)}}handleHtmlExport(t){let e=t?"1":"0",n=`${location.origin}/invoice/inv/html/${e}`;window.open(n,"_blank")}async handlePaymentSubmit(){let t=`${location.origin}/invoice/payment/add_with_ajax`,e=document.getElementById("btn_modal_payment_submit"),n=e?.innerHTML;e&&(e.innerHTML='<i class="fa fa-spin fa-spinner"></i>',e.disabled=!0);try{let i={amount:_("payment_amount"),payment_method:_("payment_method"),payment_date:_("payment_date")},o=await p(t,i);u(o).success===1?(e&&(e.innerHTML='<i class="fa fa-check"></i>'),this.closeModal("payment-modal"),setTimeout(()=>{window.location.reload()},500)):(e&&n&&(e.innerHTML=n,e.disabled=!1),alert("Failed to process payment. Please try again."))}catch(i){console.error("Payment submission error:",i),e&&n&&(e.innerHTML=n,e.disabled=!1),alert("An error occurred while processing payment. See console for details.")}}handleAddRowModal(){let e=new URL(location.href).pathname.split("/").at(-1)||"",n=`${location.origin}/invoice/invitem/add/${e}`,i=document.getElementById("modal-placeholder-invitem");i&&fetch(n,{credentials:"same-origin"}).then(o=>o.text()).then(o=>{i.textContent="";let s=document.createElement("div");s.textContent=o;let r=document.createDocumentFragment(),l=new DOMParser;try{let c=l.parseFromString(o,"text/html");if(c&&c.body){for(;c.body.firstChild;)r.appendChild(c.body.firstChild);i.appendChild(r)}}catch(c){console.error("HTML parsing error:",c),i.textContent="Error loading content"}}).catch(o=>{console.error("Failed to load modal content:",o),i.textContent="Failed to load item form. Please try again."})}handleAddInvoiceItemRow(){let t=document.getElementById("new_row"),e=document.getElementById("item_table");if(t&&e){let n=t.cloneNode(!0);n.removeAttribute("id"),n.classList.add("item"),n.style.display="block",e.appendChild(n)}}async handleDeleteSingleItem(t){let e=t.getAttribute("data-id");if(!e){let n=t.closest(".item");n&&n.remove();return}try{let n=`${location.origin}/invoice/inv/delete_item/${e}`,i=await p(n,{id:e});if(u(i).success===1){let s=t.closest(".item");s&&s.remove(),alert("Deleted"),window.location.reload()}else alert("Failed to delete item. Please try again.")}catch(n){console.error("Delete item error:",n),alert("An error occurred while deleting the item. Please try again.")}}handleSelectAllCheckboxes(t){document.querySelectorAll('input[type="checkbox"]').forEach(n=>{n.checked=t})}initializeAllClientsCheck(){this.handleAllClientsCheck()}handleAllClientsCheck(){let t=document.getElementById("user_all_clients"),e=document.getElementById("list_client");t&&e&&(t.checked?e.style.display="none":e.style.display="block")}closeModal(t){try{if(typeof window.bootstrap?.Modal<"u"){let e=document.getElementById(t);if(e){let n=window.bootstrap.Modal.getInstance(e);n&&n.hide()}}}catch(e){console.warn("Failed to close modal:",e)}}};function Y(a,t){a.forEach(e=>{t?e.innerHTML='<h6 class="text-center"><i class="fa fa-spin fa-spinner"></i></h6>':e.innerHTML='<h6 class="text-center"><i class="fa fa-check"></i></h6>'})}function Z(a){a.forEach(t=>{t.innerHTML='<h6 class="text-center"><i class="fa fa-error"></i></h6>'})}var R=class{constructor(){this.bindEventListeners(),this.exposeGlobalFunctions(),this.initializeComponents()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0)}handleClick(t){let e=t.target;if(e.closest("#product_filters_submit")){this.submitProductFilters(t);return}if(e.closest(".select-items-confirm-quote")){t.preventDefault(),this.handleQuoteConfirm();return}if(e.closest(".select-items-confirm-inv")){t.preventDefault(),this.handleInvoiceConfirm();return}let n=e.closest(".product");if(n&&e.tagName!=="INPUT"){let i=n.querySelector('input[type="checkbox"]');i&&i.click();return}e.matches("input[name='product_ids[]']")&&this.updateButtonStates()}initializeComponents(){typeof window.TomSelect<"u"&&document.querySelectorAll(".simple-select").forEach(t=>{t._tomselect||(new window.TomSelect(t,{}),t._tomselect=!0)}),this.updateButtonStates()}updateButtonStates(){let e=document.querySelectorAll("input[name='product_ids[]']:checked").length>0,n=document.querySelector(".select-items-confirm-quote"),i=document.querySelector(".select-items-confirm-inv");n&&(n.disabled=!e),i&&(i.disabled=!e)}filterTableBySku(){let t=document.getElementById("filter_product_sku");if(!t)return;let n=(t.value||"").toUpperCase(),i=document.getElementById("table-product");if(!i)return;let o=i.getElementsByTagName("tr");for(let s=0;s<o.length;s++){let r=o[s].getElementsByTagName("td")[2];r&&((r.textContent||r.innerText||"").toUpperCase().indexOf(n)>-1?o[s].style.display="":o[s].style.display="none")}}async submitProductFilters(t){t?.preventDefault&&t.preventDefault();let e=`${location.origin}/invoice/product/search`,n=document.querySelectorAll(".product_filters_submit");Y(n,!0);try{let s={product_sku:document.getElementById("filter_product_sku")?.value||""},r=await p(e,s),l=u(r);l.success===1?(this.filterTableBySku(),this.hideSummaryBar(),Y(n,!1)):(Z(n),l.message&&alert(l.message))}catch(i){console.error("product search failed",i),Z(n),alert("An error occurred while searching products. See console for details.")}}hideSummaryBar(){let t=document.querySelector(".mt-3.me-3.summary.text-end");t&&(t.style.visibility="hidden")}async handleQuoteConfirm(){let t=new URL(window.location.href),e=document.querySelector(".select-items-confirm-quote");this.setSecureButtonContent(e,"h2","text-center","fa fa-spin fa-spinner");let n=[],i=(t.pathname.split("/").at(-1)||"").replace(/[^0-9]/g,"");document.querySelectorAll("input[name='product_ids[]']:checked").forEach(r=>{let l=parseInt(r.value);isNaN(l)||n.push(l)});let o=n.toSorted((r,l)=>r-l);console.log("Processing products in sorted order:",o);let s=`/invoice/product/selection_quote?quote_id=${i}`;o.forEach(r=>{s+=`&product_ids[]=${r}`});try{let l=await(await fetch(s,{method:"GET",headers:{"Content-Type":"application/json; charset=utf-8","X-Requested-With":"XMLHttpRequest"}})).json();this.processProducts(l),this.setSecureButtonContent(e,"h2","text-center","fa fa-check"),window.location.reload()}catch(r){console.error("Error:",r),this.setSecureButtonContent(e,"h2","text-center","fa fa-times")}}async handleInvoiceConfirm(){let t=new URL(window.location.href),e=document.querySelector(".select-items-confirm-inv");this.setSecureButtonContent(e,"h2","text-center","fa fa-spin fa-spinner");let n=[],i=t.pathname.split("/").at(-1)||"";document.querySelectorAll("input[name='product_ids[]']:checked").forEach(r=>{let l=parseInt(r.value);isNaN(l)||n.push(l)});let o=n.toSorted((r,l)=>r-l),s=`/invoice/product/selection_inv?inv_id=${i}`;o.forEach(r=>{s+=`&product_ids[]=${r}`});try{let l=await(await fetch(s,{method:"GET",headers:{"Content-Type":"application/json; charset=utf-8","X-Requested-With":"XMLHttpRequest"}})).json();this.processProducts(l),this.setSecureButtonContent(e,"h2","text-center","fa fa-check"),window.location.reload()}catch(r){console.error("Error:",r),this.setSecureButtonContent(e,"h2","text-center","fa fa-times")}}processProducts(t){console.log("Processing",Object.keys(t).length,"products");let e=Object.groupBy(Object.entries(t).map(([n,i])=>({key:n,...i})),n=>n.tax_rate_id||"default");console.log("Products grouped by tax rate:",Object.keys(e));for(let n in t){console.log("Processing product key:",n);let i=t[n];if(!i||typeof i!="object")continue;let o=i.tax_rate_id,s;if(o)s=o;else{let l=document.getElementById("default_item_tax_rate");s=l&&l.getAttribute("value")||""}let r=document.querySelector("#item_table tbody:last-of-type");if(r){let l=r.querySelector("input[name=item_name]");l&&(l.value=i.product_name);let c=r.querySelector("textarea[name=item_description]");c&&(c.value=i.product_description);let m=r.querySelector("input[name=item_price]");m&&(m.value=i.product_price);let d=r.querySelector("input[name=item_quantity]");d&&(d.value="1");let f=r.querySelector("select[name=item_tax_rate_id]");f&&(f.value=s);let h=r.querySelector("input[name=item_product_id]");h&&(h.value=i.id);let E=r.querySelector("select[name=item_product_unit_id]");E&&(E.value=i.unit_id)}}}setSecureButtonContent(t,e,n,i){if(!t)return;for(;t.firstChild;)t.removeChild(t.firstChild);let o=document.createElement(e);n&&(o.className=n);let s=document.createElement("i");i&&(s.className=i),o.appendChild(s),t.appendChild(o)}exposeGlobalFunctions(){window.productTableFilter=this.filterTableBySku.bind(this)}};var A=class{constructor(){this.bindEventListeners(),this.initializeComponents()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0),document.addEventListener("change",this.handleChange.bind(this),!0),document.addEventListener("keydown",this.handleKeydown.bind(this),!0),document.addEventListener("shown.bs.modal",this.handleModalShown.bind(this),!0)}handleClick(t){let e=t.target;if(e.closest("#tasks_table tr, .task, .task-row")){this.rowClickToggle(t);return}let i=e.closest(".select-items-confirm-task, .select-items-confirm-task-inv, .select-items-confirm-task-quote");if(i){this.handleSelectItemsConfirmTask(i);return}if(e.closest("#task-reset-button-inv")){this.handleTaskReset();return}}handleChange(t){let e=t.target;if(e.matches("input[name='task_ids[]']")){let n=e.closest("#tasks_table")||document;this.updateSelectTaskButtonState(n)}}handleKeydown(t){if(t.key==="Enter"){let e=document.activeElement;if(e&&e.id==="filter_task_inv"){let n=document.getElementById("filter-button-inv");n&&(n.click(),t.preventDefault())}}}initializeComponents(){this.hideSelectedTasks(),this.updateSelectTaskButtonState(document)}handleModalShown(t){let e=t.target;(e.id==="modal-choose-tasks"||e.id==="modal-choose-tasks-inv")&&(console.log("Task modal shown, reinitializing components..."),this.hideSelectedTasks(),this.updateSelectTaskButtonState(document))}hideSelectedTasks(){let t=[];document.querySelectorAll(".item-task-id").forEach(i=>{let s=i.value||"";if(s.length){let r=parseInt(s,10);isNaN(r)||t.push(r)}});let e=0;document.querySelectorAll(".modal-task-id").forEach(i=>{let o=i.id||"",s=parseInt(o.replace("task-id-",""),10);if(!Number.isNaN(s)&&t.includes(s)){let r=i.closest("tr")||i.parentElement&&i.parentElement.parentElement;r&&(r.style.display="none",e++)}});let n=document.querySelectorAll(".task-row");if(e>=n.length){let i=document.getElementById("task-modal-submit")||document.getElementById("task-modal-submit-quote");i&&(i.style.display="none")}}rowClickToggle(t){let e=t.target.closest("#tasks_table tr, .task-row, .task");if(!e)return;if(t.target.type!=="checkbox"){let i=e.querySelector('input[type="checkbox"]');i&&(i.checked=!i.checked,i.dispatchEvent(new Event("change",{bubbles:!0})))}}updateSelectTaskButtonState(t){let e=t||document,n=e.querySelectorAll("input[name='task_ids[]']"),i=e.querySelectorAll("input[name='task_ids[]']:checked"),o=i.length>0;console.log(`\u{1F50D} Task button state update: ${n.length} total checkboxes, ${i.length} checked, anyChecked: ${o}`);let s;if(s=e.querySelectorAll(".select-items-confirm-task, .select-items-confirm-task-inv, .select-items-confirm-task-quote"),s.length===0&&(s=document.querySelectorAll(".select-items-confirm-task, .select-items-confirm-task-inv, .select-items-confirm-task-quote")),s.length===0){let r=document.getElementById("task-modal-submit")||document.getElementById("task-modal-submit-quote");r&&(s=[r],console.log("\u{1F50D} Found button by ID fallback"))}s.length===0&&document.querySelectorAll(".modal").forEach(l=>{let c=l.querySelectorAll(".select-items-confirm-task, .select-items-confirm-task-inv, .select-items-confirm-task-quote, #task-modal-submit, #task-modal-submit-quote");c.length>0&&(s=c,console.log("\u{1F50D} Found button in modal fallback"))}),console.log(`\u{1F50D} Found ${s.length} task submit buttons`),s.forEach(r=>{let l=r;o?(l.removeAttribute("disabled"),l.removeAttribute("aria-disabled"),l.disabled=!1,console.log("\u2705 Task submit button enabled")):(l.setAttribute("disabled","true"),l.setAttribute("aria-disabled","true"),l.disabled=!0,console.log("\u274C Task submit button disabled"))})}async handleSelectItemsConfirmTask(t){let e=new URL(location.href),n=e.pathname.split("/").at(-1)||"",i=e.pathname.includes("/quote/"),o=e.pathname.includes("/inv/"),s=Array.from(document.querySelectorAll("input[name='task_ids[]']:checked")).map(d=>parseInt(d.value,10)).filter(d=>!isNaN(d));if(s.length===0)return;let r=s.toSorted((d,f)=>d-f);console.log("Processing tasks in sorted order:",r);let l=t.innerHTML;t.innerHTML='<h2 class="text-center"><i class="fa fa-spin fa-spinner"></i></h2>',t.disabled=!0;let c=new URLSearchParams;r.forEach(d=>{c.append("task_ids[]",d.toString())}),i?c.append("quote_id",n):c.append("inv_id",n);let m=i?"selection_quote":"selection_inv";try{let d=await fetch(`/invoice/task/${m}?${c.toString()}`,{method:"GET",credentials:"same-origin",cache:"no-store",headers:{Accept:"application/json"}});if(!d.ok)throw new Error(`Network response not ok: ${d.status}`);let f=await d.text(),h;try{h=JSON.parse(f)}catch{h=f}let E=u(h);this.processTasks(E),t.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>',location.reload()}catch(d){console.error("selection_inv failed",d),t.innerHTML=l,t.disabled=!1;let f=new Error("An error occurred while adding tasks to invoice. See console for details.",{cause:d});alert(f.message)}}processTasks(t){let e=null,n=Object.groupBy(Object.entries(t).map(([i,o])=>({key:i,...o})),i=>i.tax_rate_id||"default");console.log("Tasks grouped by tax rate:",Object.keys(n)),Object.entries(t).toReversed().forEach(([i,o])=>{let s=o.tax_rate_id;if(s)e=s;else{let E=document.getElementById("default_item_tax_rate")||document.querySelector("#default_item_tax_rate");e=E?E.getAttribute("value"):""}let r=document.querySelector("#item_table tbody:last-of-type")||document.querySelector("#item_table tbody");if(!r)return;let l=r.querySelector('input[name="item_name"]'),c=r.querySelector('textarea[name="item_description"]'),m=r.querySelector('input[name="item_price"]'),d=r.querySelector('input[name="item_quantity"]'),f=r.querySelector('select[name="item_tax_rate_id"]'),h=r.querySelector('input[name="item_task_id"]');l&&(l.value=o.name||""),c&&(c.value=o.description||""),m&&(m.value=o.price||""),d&&(d.value="1"),f&&(f.value=e||""),h&&(h.value=o.id||"")})}async handleTaskReset(){let t=document.querySelector("#tasks_table");if(!t)return;let e=`${location.origin}/invoice/task/lookup?rt=true`;t.innerHTML='<h2 class="text-center"><i class="fa fa-spin fa-spinner"></i></h2>';let{promise:n,resolve:i,reject:o}=Promise.withResolvers(),s=setTimeout(()=>{o(new Error("Task lookup timeout",{cause:"Server did not respond within expected timeframe"}))},1e4);try{let l=await(await fetch(e,{cache:"no-store",credentials:"same-origin"})).text(),m=new DOMParser().parseFromString(l,"text/html"),d=document.createDocumentFragment();Array.from(m.body.children).toReversed().forEach(f=>{d.insertBefore(f,d.firstChild)}),t.innerHTML="",t.appendChild(d),this.updateSelectTaskButtonState(t),clearTimeout(s),i()}catch(r){clearTimeout(s),console.error("task lookup load failed",r),o(r)}n.then(()=>{document.querySelectorAll(".select-items-confirm-task").forEach(r=>{r.removeAttribute("disabled")})}).catch(r=>{console.error("Task reset failed:",r),document.querySelectorAll(".select-items-confirm-task").forEach(l=>{l.removeAttribute("disabled")})})}};function ce(a,t){let n=new DOMParser().parseFromString(t,"text/html"),i=document.createDocumentFragment();Array.from(n.body.children).forEach(o=>i.appendChild(o)),a.innerHTML="",a.appendChild(i)}function de(){window.location.reload()}var B=class{constructor(){this.bindEventListeners(),this.initializeOnLoad()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0)}initializeOnLoad(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.initSelects()}):this.initSelects()}handleClick(t){let e=t.target;if(e.matches("#salesorder_to_pdf_confirm_with_custom_fields")||e.closest("#salesorder_to_pdf_confirm_with_custom_fields")){this.handlePdfExport(!0);return}if(e.matches("#salesorder_to_pdf_confirm_without_custom_fields")||e.closest("#salesorder_to_pdf_confirm_without_custom_fields")){this.handlePdfExport(!1);return}if(e.matches("#so_to_invoice_confirm")||e.closest("#so_to_invoice_confirm")){this.handleSoToInvoiceConversion();return}let n=e.closest(".open-salesorder-modal");if(n){this.handleOpenModal(n);return}if(e.closest(".salesorder-save")){this.handleSaveSalesOrder();return}}initSelects(){if(typeof window.TomSelect>"u")return;document.querySelectorAll(".simple-select").forEach(e=>{if(!e._tomselect)try{new window.TomSelect(e,{}),e._tomselect=!0}catch(n){console.warn("Failed to initialize TomSelect:",n)}})}async handleOpenModal(t){let e=t.dataset.url||`${location.origin}/invoice/salesorder/modal`,n=t.dataset.target||"modal-placeholder-salesorder",i=document.getElementById(n);if(!i){console.error(`Modal target element not found: ${n}`);return}try{let s=await(await fetch(e,{cache:"no-store",credentials:"same-origin"})).text();ce(i,s);let r=i.querySelector(".modal");r&&window.bootstrap?.Modal&&new window.bootstrap.Modal(r).show(),this.initSelects()}catch(o){console.error("Failed to load sales order modal:",o),alert("Failed to load modal. Please try again.")}}handlePdfExport(t){let e=location.origin+"/invoice/salesorder/pdf/"+(t?"1":"0");window.location.reload(),window.open(e,"_blank")}async handleSoToInvoiceConversion(){let t=document.querySelector(".so_to_invoice_confirm");t&&(t.innerHTML='<i class="fa fa-spin fa-spinner fa-margin"></i>');let e=document.getElementById("so_id"),n=document.getElementById("client_id"),i=document.getElementById("group_id"),o=document.getElementById("password");if(!e?.value||!n?.value||!i?.value){console.error("Required fields missing for SO to Invoice conversion"),alert("Missing required data for conversion");return}let s={so_id:e.value,client_id:n.value,group_id:i.value,password:o?.value||""};try{let r=location.origin+"/invoice/salesorder/so_to_invoice_confirm",l=await p(r,s);l&&l.success===1?(t&&(t.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),de()):(l?.validation_errors&&(document.querySelectorAll(".control-group").forEach(c=>{c.classList.remove("error")}),Object.entries(l.validation_errors).forEach(([c,m])=>{let d=document.getElementById(c);d?.parentElement&&d.parentElement.classList.add("has-error")})),t&&(t.innerHTML='<h6 class="text-center"><i class="fa fa-check"></i></h6>'))}catch(r){console.error("SO to Invoice conversion failed:",r),t&&(t.innerHTML='<h6 class="text-center"><i class="fa fa-check"></i></h6>'),alert("An error occurred during conversion. Please try again.")}}async handleSaveSalesOrder(){let t=document.querySelector("#salesorder_form");if(!t){console.error("Sales order form not found");return}try{let e=t.getAttribute("action")||`${location.origin}/invoice/salesorder/save`,n=new FormData(t),i=new URLSearchParams;n.forEach((c,m)=>{i.append(m,c.toString())});let o=`${e}?${i.toString()}`,r=await(await fetch(o,{cache:"no-store",credentials:"same-origin",headers:{Accept:"application/json"}})).json(),l=u(r);if(l.success===1)window.location.reload();else{let c=l.message||"Save failed";alert(c)}}catch(e){console.error("Sales order save failed:",e),alert("An error occurred while saving. Please try again.")}}};var F=class{constructor(){this.bindEventListeners()}bindEventListeners(){document.addEventListener("DOMContentLoaded",this.initializeSelectors.bind(this)),document.addEventListener("click",this.handleClick.bind(this),!0)}handleClick(t){if(t.target.closest("#process-generate-products")){this.processProductGeneration();return}}initializeSelectors(){let t=document.getElementById("family-category-primary-id"),e=document.getElementById("family-category-secondary-id");t&&(t.addEventListener("change",this.onPrimaryChange.bind(this),!1),this.initializeSelector(()=>this.onPrimaryChange())),e&&(e.addEventListener("change",this.onSecondaryChange.bind(this),!1),this.initializeSelector(()=>this.onSecondaryChange()))}initializeSelector(t){let{promise:e,resolve:n,reject:i}=Promise.withResolvers(),o=setTimeout(()=>{i(new Error("Selector initialization timeout",{cause:"DOM not ready within expected timeframe"}))},5e3);setTimeout(()=>{clearTimeout(o),n()},0),e.then(()=>t()).catch(s=>{console.error("Selector initialization failed:",s);try{t()}catch(r){console.error("Callback execution failed:",r)}})}populateSelect(t,e,n){if(!t)return;t.innerHTML="";let i=document.createElement("option");i.value="",i.textContent=n||"None",t.appendChild(i),e&&(Array.isArray(e)?e.forEach((o,s)=>{let r=document.createElement("option");r.value=s.toString(),r.textContent=o,t.appendChild(r)}):Object.entries(e).forEach(([o,s])=>{let r=document.createElement("option");r.value=o,r.textContent=s,t.appendChild(r)}))}async onPrimaryChange(){let t=document.getElementById("family-category-primary-id");if(!t)return;let e=t.value||"",n=`${location.origin}/invoice/family/secondaries/${encodeURIComponent(e)}`;try{let o=await p(n,{category_primary_id:e}),s=u(o);if(s.success===1){let r=s.secondary_categories||{},l=document.getElementById("family-category-secondary-id");if(this.populateSelect(l,r,"None"),l){let c=new Event("change",{bubbles:!0});l.dispatchEvent(c)}}else this.populateSelect(document.getElementById("family-category-secondary-id"),{},"None"),this.populateSelect(document.getElementById("family-name"),{},"None")}catch(i){console.error("Error loading secondary categories",i),this.populateSelect(document.getElementById("family-category-secondary-id"),{},"None"),this.populateSelect(document.getElementById("family-name"),{},"None")}}async onSecondaryChange(){let t=document.getElementById("family-category-secondary-id");if(!t)return;let e=t.value||"",n=`${location.origin}/invoice/family/names/${encodeURIComponent(e)}`;try{let o=await p(n,{category_secondary_id:e}),s=u(o);if(s.success===1){let r=s.family_names||{},l=document.getElementById("family-name");this.populateSelect(l,r,"None")}else this.populateSelect(document.getElementById("family-name"),{},"None")}catch(i){console.error("Error loading family names",i),this.populateSelect(document.getElementById("family-name"),{},"None")}}getFamilyDataFromCheckedBoxes(){let t=[];return document.querySelectorAll('input[name="family_ids[]"]:checked').forEach(n=>{let i=n.closest("tr");if(!i)return;let o=n.value,s=i.querySelector("[data-family-name]"),r=i.querySelector("[data-family-prefix]"),l=i.querySelector("[data-family-commalist]"),c={family_id:o,family_name:s?.textContent?.trim()||"",family_productprefix:r?.textContent?.trim()||"",family_commalist:l?.textContent?.trim()||""};t.push(c)}),t}async processProductGeneration(){let t=document.getElementById("tax_rate_id"),e=document.getElementById("unit_id"),n=document.getElementById("process-generate-products");if(!t?.value||!e?.value){alert("Please select both tax rate and unit.");return}let i=this.getFamilyDataFromCheckedBoxes();if(i.length===0){alert("No families selected.");return}let o=n.innerHTML;n.innerHTML='<i class="fa fa-spin fa-spinner"></i> Generating...',n.disabled=!0;try{let s=i.map(d=>d.family_id),r=document.querySelector('input[name="_csrf"]')?.value||"",l={family_ids:s,tax_rate_id:t.value,unit_id:e.value,_csrf:r},m=await(await fetch(`${location.origin}/invoice/family/generate_products`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:new URLSearchParams(l).toString()})).json();if(m.success){n.innerHTML='<i class="fa fa-check"></i> Success!',alert(m.message||`Successfully generated ${m.count||0} products!`),m.warnings&&m.warnings.length>0&&console.warn("Warnings during product generation:",m.warnings);let d=document.getElementById("generate-products-modal");if(d&&typeof window.bootstrap?.Modal<"u"){let f=window.bootstrap.Modal.getInstance(d);f&&f.hide()}setTimeout(()=>{window.location.reload()},1e3)}else n.innerHTML=o,n.disabled=!1,alert(`Error: ${m.message||"Unknown error occurred"}`)}catch(s){console.error("Product generation error:",s),n.innerHTML=o,n.disabled=!1,alert("An error occurred while generating products. Please try again.")}}};var D=class{originalDisplayStyles={};originalDisabledStates={};constructor(){this.bindEventListeners()}bindEventListeners(){document.addEventListener("DOMContentLoaded",this.initialize.bind(this))}initialize(){this.toggleSmtpSettings();let t=document.getElementById("email_send_method");t&&t.addEventListener("change",this.toggleSmtpSettings.bind(this));let e=document.getElementById("btn_fph_generate");e&&e.addEventListener("click",s=>{s.preventDefault(),this.handleFphGenerateClick()});let n=document.getElementById("form-settings"),i=document.getElementById("btn-submit");i&&n&&n.contains(i)&&i.addEventListener("click",s=>{s.preventDefault(),this.handleSettingsSubmitClick()});let o=document.getElementById("online-payment-select");o&&o.addEventListener("change",this.handleOnlinePaymentSelectChange.bind(this)),this.handleOnlinePaymentSelectChange()}toggleSmtpSettings(){let t=document.getElementById("email_send_method"),e=document.getElementById("div-smtp-settings");!e||!t||(t.value==="smtp"?e.style.display="":e.style.display="none")}async handleFphGenerateClick(){let t=`${location.origin}/invoice/setting/fphgenerate`,e={userAgent:navigator.userAgent,width:window.screen.width,height:window.screen.height,scalingFactor:Math.round(window.devicePixelRatio*100)/100,colourDepth:window.screen.colorDepth,windowInnerWidth:window.innerWidth,windowInnerHeight:window.innerHeight},n=new URLSearchParams;Object.entries(e).forEach(([i,o])=>{n.append(i,o.toString())});try{let i=await fetch(`${t}?${n.toString()}`,{method:"GET",credentials:"same-origin",cache:"no-store",headers:{Accept:"application/json"}});if(!i.ok)throw new Error(`Network response not ok: ${i.status}`);let o=await i.json().catch(()=>({})),s=u(o);s.success===1&&(this.updateSettingField("settings[fph_client_browser_js_user_agent]",s.userAgent),this.updateSettingField("settings[fph_client_device_id]",s.deviceId),this.updateSettingField("settings[fph_screen_width]",s.width),this.updateSettingField("settings[fph_screen_height]",s.height),this.updateSettingField("settings[fph_screen_scaling_factor]",s.scalingFactor),this.updateSettingField("settings[fph_screen_colour_depth]",s.colourDepth),this.updateSettingField("settings[fph_timestamp]",s.timestamp),this.updateSettingField("settings[fph_window_size]",s.windowSize),this.updateSettingField("settings[fph_gov_client_user_id]",s.userUuid))}catch(i){console.error("FPH generate failed",i)}}updateSettingField(t,e){let n=document.getElementById(t);n&&e!==void 0&&(n.value=e)}handleSettingsSubmitClick(){let t=document.getElementById("form-settings");if(!t)return;let e=t.querySelectorAll(".tab-pane");this.originalDisplayStyles={},this.originalDisabledStates={},Array.from(e).toReversed().forEach(n=>{n.id&&(this.originalDisplayStyles[n.id]=n.style.display,n.style.display="block",n.querySelectorAll("input:disabled, select:disabled, textarea:disabled").forEach((o,s)=>{let r=`${n.id}_${s}`;this.originalDisabledStates[r]={element:o,disabled:!0},o.disabled=!1}))}),setTimeout(()=>{t.submit(),this.restoreFormState(e)},10)}restoreFormState(t){t.forEach(e=>{e.id&&this.originalDisplayStyles[e.id]!==void 0&&(e.style.display=this.originalDisplayStyles[e.id])}),Object.entries(this.originalDisabledStates).forEach(([e,n])=>{n.element&&n.disabled&&(n.element.disabled=!0)})}handleOnlinePaymentSelectChange(){let t=document.getElementById("online-payment-select");if(!t)return;let e=t.value;document.querySelectorAll(".gateway-settings").forEach(o=>{o.classList.contains("active-gateway")||o.classList.add("hidden")});let i=document.getElementById(`gateway-settings-${e}`);i&&(i.classList.remove("hidden"),i.classList.add("active-gateway"))}};function U(){let a=window.bootstrap;if(typeof a>"u"||!a.Tooltip)return;document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(e=>{try{new a.Tooltip(e)}catch{}})}function z(a){let t=window.TomSelect;if(typeof t>"u")return;(a||document).querySelectorAll(".simple-select").forEach(i=>{i._tomselect||(new t(i,{}),i._tomselect=!0)})}function j(){let a=document.getElementById("fullpage-loader"),t=document.getElementById("loader-error"),e=document.getElementById("loader-icon");a&&(a.style.display="block"),t&&(t.style.display="none"),e&&(e.classList.add("fa-spin"),e.classList.remove("text-danger")),setTimeout(()=>{t&&(t.style.display="block"),e&&(e.classList.remove("fa-spin"),e.classList.add("text-danger"))},1e4)}function Q(){let a=document.getElementById("fullpage-loader"),t=document.getElementById("loader-error"),e=document.getElementById("loader-icon");a&&(a.style.display="none"),t&&(t.style.display="none"),e&&(e.classList.add("fa-spin"),e.classList.remove("text-danger"))}function G(){let a=document.querySelector(".passwordmeter-input");a&&a.addEventListener("input",()=>{let t=a.value,e=me(t),n=document.querySelector(".passmeter-2"),i=document.querySelector(".passmeter-3");n&&i&&(n.style.display="none",i.style.display="none",e>=4?(n.style.display="block",i.style.display="block"):e>=3&&(n.style.display="block"))})}function me(a){let t=0;return a.length>=8&&t++,/[a-z]/.test(a)&&t++,/[A-Z]/.test(a)&&t++,/[0-9]/.test(a)&&t++,/[^A-Za-z0-9]/.test(a)&&t++,t}function ue(){document.addEventListener("DOMContentLoaded",()=>{U(),z(),G(),document.addEventListener("click",a=>{let t=a.target;t.classList.contains("ajax-loader")&&j(),t.classList.contains("fullpage-loader-close")&&Q()})})}ue();var V=class{container;textarea;selectedNumbers=new Set;currentPage=1;numbersPerPage=50;totalPages=4;constructor(t,e){if(this.container=document.getElementById(t),this.textarea=document.getElementById(e),!this.container||!this.textarea)throw new Error("Required elements not found");this.parseInitialValue(),this.render(),this.attachEventListeners()}parseInitialValue(){if(this.textarea.value){let t=this.textarea.value.split(",").map(e=>parseInt(e.trim())).filter(e=>!isNaN(e)&&e>=1&&e<=200);this.selectedNumbers=new Set(t)}}render(){this.container.innerHTML=this.getHTML()}getHTML(){let t=this.getPaginatedNumbers(),e=this.selectedNumbers.size,n=this.getPageInfo();return`
            <div class="family-commalist-picker">
                <div class="picker-header mb-3">
                    <h5 class="mb-2">
                        <i class="bi bi-list-ol"></i> 
                        Select Numbers (1-200)
                    </h5>
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="selected-info">
                            <span class="badge bg-primary me-2">
                                ${e} selected
                            </span>
                            <span class="text-muted small">${n}</span>
                        </div>
                        
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-success" onclick="picker.selectPage()" title="Select all numbers on current page">
                                <i class="bi bi-check-square"></i> Page
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="picker.deselectPage()" title="Deselect all numbers on current page">
                                <i class="bi bi-square"></i> Page
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="picker.clearAll()" title="Clear all selections">
                                <i class="bi bi-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Range Selection -->
                <div class="quick-ranges mb-3">
                    <small class="text-muted d-block mb-2">Quick ranges:</small>
                    <div class="btn-group btn-group-sm flex-wrap" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="picker.selectRange(1, 10)" title="Select 1-10">1-10</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="picker.selectRange(11, 25)" title="Select 11-25">11-25</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="picker.selectRange(26, 50)" title="Select 26-50">26-50</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="picker.selectRange(51, 100)" title="Select 51-100">51-100</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="picker.selectRange(101, 150)" title="Select 101-150">101-150</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="picker.selectRange(151, 200)" title="Select 151-200">151-200</button>
                    </div>
                </div>

                <!-- Number Grid -->
                <div class="numbers-grid mb-3">
                    <div class="number-buttons">
                        ${t.map(i=>`
                            <button type="button" 
                                    class="btn number-btn ${this.selectedNumbers.has(i)?"btn-success":"btn-outline-secondary"}"
                                    onclick="picker.toggleNumber(${i})"
                                    title="Toggle number ${i}">
                                ${i}
                            </button>
                        `).join("")}
                    </div>
                </div>

                <!-- Pagination -->
                <div class="pagination-controls d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="picker.prevPage()" ${this.currentPage===1?"disabled":""}>
                        <i class="bi bi-chevron-left"></i> Previous
                    </button>
                    
                    <div class="page-buttons">
                        ${[1,2,3,4].map(i=>`
                            <button type="button" 
                                    class="btn btn-sm me-1 ${i===this.currentPage?"btn-primary":"btn-outline-primary"}"
                                    onclick="picker.goToPage(${i})">
                                ${i}
                            </button>
                        `).join("")}
                    </div>
                    
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="picker.nextPage()" ${this.currentPage===this.totalPages?"disabled":""}>
                        Next <i class="bi bi-chevron-right"></i>
                    </button>
                </div>

                ${e>0?`
                    <div class="selected-preview mt-3">
                        <small class="text-muted d-block mb-1">Selected numbers:</small>
                        <div class="selected-numbers-display">
                            <span class="text-muted small">${Array.from(this.selectedNumbers).sort((i,o)=>i-o).join(", ")}</span>
                        </div>
                    </div>
                `:""}
            </div>
        `}getPaginatedNumbers(){let t=(this.currentPage-1)*this.numbersPerPage,e=t+this.numbersPerPage;return Array.from({length:200},(i,o)=>o+1).slice(t,e)}getPageInfo(){let t=(this.currentPage-1)*this.numbersPerPage+1,e=Math.min(this.currentPage*this.numbersPerPage,200);return`${t}-${e} of 200`}toggleNumber(t){this.selectedNumbers.has(t)?this.selectedNumbers.delete(t):this.selectedNumbers.add(t),this.updateTextarea(),this.render()}clearAll(){this.selectedNumbers.clear(),this.updateTextarea(),this.render()}selectRange(t,e){for(let n=t;n<=e;n++)n>=1&&n<=200&&this.selectedNumbers.add(n);this.updateTextarea(),this.render()}selectPage(){this.getPaginatedNumbers().forEach(t=>{this.selectedNumbers.add(t)}),this.updateTextarea(),this.render()}deselectPage(){this.getPaginatedNumbers().forEach(t=>{this.selectedNumbers.delete(t)}),this.updateTextarea(),this.render()}goToPage(t){t>=1&&t<=this.totalPages&&(this.currentPage=t,this.render())}nextPage(){this.currentPage<this.totalPages&&(this.currentPage++,this.render())}prevPage(){this.currentPage>1&&(this.currentPage--,this.render())}updateTextarea(){let e=Array.from(this.selectedNumbers).sort((n,i)=>n-i).join(", ");this.textarea.value=e,this.textarea.dispatchEvent(new Event("change",{bubbles:!0})),this.textarea.dispatchEvent(new Event("input",{bubbles:!0}))}attachEventListeners(){this.textarea.addEventListener("input",()=>{this.parseInitialValue(),this.render()})}},W=null;function ee(){window.toggleCommalistPicker=pe,window.picker=null}function pe(){let a=document.getElementById("commalist-picker-container"),t=document.getElementById("toggle-picker-btn");if(!(!a||!t))if(a.style.display==="none"){if(a.style.display="block",t.innerHTML='<i class="bi bi-grid-3x3-gap-fill"></i> Hide Number Picker',!W){let e=document.createElement("div");e.id="number-picker";let n=a.querySelector(".alert");n&&n.nextSibling?a.insertBefore(e,n.nextSibling):a.appendChild(e),W=new V("number-picker","family_commalist"),window.picker=W}}else a.style.display="none",t.innerHTML='<i class="bi bi-grid-3x3-gap"></i> Show Number Picker'}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ee):ee();console.log("Invoice TypeScript bundle loaded");var H=class{#e;#t;#n;#i;#o;#s;#r;#a;#l;constructor(){this.#e=new k,this.#t=new I,this.#n=new C,this.#i=new P,this.#o=new R,this.#s=new A,this.#r=new B,this.#a=new F,this.#l=new D,this.initializeTooltips(),this.initializeTaggableFocus(),U(),z(),G(),this.initializeFullpageLoader(),console.log("Invoice TypeScript App initialized with all core handlers: Quote, Client, Invoice, Product, Task, SalesOrder, Family, and Settings")}initializeTooltips(){document.addEventListener("DOMContentLoaded",()=>{typeof bootstrap<"u"&&bootstrap.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(e=>{try{new bootstrap.Tooltip(e)}catch(n){console.warn("Tooltip initialization failed:",n)}})})}initializeTaggableFocus(){document.addEventListener("focus",t=>{let e=t.target;e?.classList?.contains("taggable")&&(window.lastTaggableClicked=e)},!0)}initializeFullpageLoader(){document.addEventListener("click",t=>{let e=t.target;e.classList.contains("ajax-loader")&&j(),e.classList.contains("fullpage-loader-close")&&Q()})}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>new H):new H;return re(fe);})();
