"use strict";var InvoiceApp=(()=>{var A=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var $=Object.prototype.hasOwnProperty;var N=(s,n)=>{for(var e in n)A(s,e,{get:n[e],enumerable:!0})},U=(s,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let o of O(n))!$.call(s,o)&&o!==e&&A(s,o,{get:()=>n[o],enumerable:!(t=D(n,o))||t.enumerable});return s};var Q=s=>U(A({},"__esModule",{value:!0}),s);var j={};N(j,{InvoiceApp:()=>w});function l(s){if(!s)return{};if(typeof s=="object"&&s!==null)return s;if(typeof s=="string")try{return JSON.parse(s)}catch{return{}}return{}}async function u(s,n,e={}){let t=s;if(n){let a=new URLSearchParams;Object.entries(n).forEach(([d,m])=>{Array.isArray(m)?m.forEach(h=>{h!=null&&a.append(`${d}[]`,String(h))}):m!=null&&a.append(d,String(m))});let c=s.includes("?")?"&":"?";t=`${s}${c}${a.toString()}`}let o={method:"GET",credentials:"same-origin",cache:"no-store",headers:{Accept:"application/json"},...e},i=await fetch(t,o);if(!i.ok)throw new Error(`Network response not ok: ${i.status}`);let r=await i.text();try{return JSON.parse(r)}catch{return r}}function T(s,n){try{if(!s)return null;if(typeof s.closest=="function")return s.closest(n);let e=s;for(;e;){if(e.matches&&e.matches(n))return e;e=e.parentElement}}catch(e){return console.warn("closestSafe error:",e),null}return null}function z(s){return document.getElementById(s)}function B(s){return document.querySelector(s)}function y(s){return z(s)?.value||""}var H=class{constructor(){this.confirmButtonSelector=".create-credit-confirm";this.initialize()}initialize(){document.addEventListener("click",this.handleClick.bind(this),!0)}async handleClick(n){let e=n.target;if(!(!e||e.id!=="create-credit-confirm")){n.preventDefault();try{await this.processCreateCredit()}catch(t){console.error("Create credit error:",t),alert(`Error: ${t instanceof Error?t.message:"Unknown error"}`)}}}async processCreateCredit(){let n=`${location.origin}/invoice/inv/create_credit_confirm`,e=B(this.confirmButtonSelector),t=new URL(location.href);e&&(e.innerHTML='<h6 class="text-center"><i class="fa fa-spin fa-spinner"></i></h6>');let i={inv_id:t.href.substring(t.href.lastIndexOf("/")+1),client_id:y("client_id"),inv_date_created:y("inv_date_created"),group_id:y("inv_group_id"),password:y("inv_password"),user_id:y("user_id")},r=await u(n,i),a=l(r);a.success===1?(e&&(e.innerHTML='<h2 class="text-center"><i class="bi bi-check2-square"></i></h2>'),a.flash_message&&alert(a.flash_message),location.href=t.href,location.reload()):(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>'),a.flash_message&&alert(a.flash_message),location.href=t.href,location.reload())}};function E(){let s=new URL(location.href);return s.href.substring(s.href.lastIndexOf("/")+1)}function f(s){return document.getElementById(s)?.value||""}function p(s,n,e){n?(s.innerHTML='<h6 class="text-center"><i class="fa fa-spin fa-spinner"></i></h6>',s.disabled=!0):(s.innerHTML=e||'<h6 class="text-center"><i class="fa fa-check"></i></h6>',s.disabled=!1)}var S=class{constructor(){this.bindEventListeners(),this.initializeComponents()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0),document.addEventListener("input",this.handleInput.bind(this),!0),document.addEventListener("focus",this.handleFocus.bind(this),!0),document.addEventListener("click",this.handleClientNoteSave.bind(this),!0),document.addEventListener("click",this.handleQuoteTaxSubmit.bind(this),!0)}handleClick(n){let e=n.target,t=e.closest(".btn_delete_item");if(t){this.handleDeleteItem(t);return}let o=e.closest(".delete-items-confirm-quote");if(o){this.handleDeleteMultipleItems(o);return}if(e.closest(".btn_add_row_modal")){this.handleAddRowModal();return}if(e.closest(".btn_quote_item_add_row")){this.handleAddQuoteItemRow();return}if(e.closest(".btn_add_row")){this.handleAddGenericRow();return}if(e.closest(".quote_add_client")){this.handleAddClientModal();return}if(e.closest("#quote_create_confirm, .quote_create_confirm")){this.handleQuoteCreateConfirm();return}let m=e.closest("#quote_with_purchase_order_number_confirm, .quote_with_purchase_order_number_confirm");if(m){this.handleQuotePurchaseOrderConfirm(m);return}let h=e.closest("#quote_to_invoice_confirm, .quote_to_invoice_confirm");if(h){this.handleQuoteToInvoiceConfirm(h);return}let _=e.closest("#quote_to_so_confirm, .quote_to_so_confirm");if(_){this.handleQuoteToSalesOrderConfirm(_);return}let g=e.closest("#quote_to_quote_confirm, .quote_to_quote_confirm");if(g){this.handleQuoteToQuoteConfirm(g);return}this.handlePdfGeneration(e)}async handleDeleteItem(n){let e=n.getAttribute("data-id");if(!e){n.closest(".item")?.remove();return}try{let t=`${location.origin}/invoice/quote/delete_item/${encodeURIComponent(e)}`,o=await u(t,{id:e}),i=l(o);i.success===1?(location.reload(),n.closest(".item")?.remove(),alert("Deleted")):console.warn("delete_item failed",i)}catch(t){console.error("delete_item error",t),alert("An error occurred while deleting item. See console for details.")}}async handleDeleteMultipleItems(n){let e=n.innerHTML;p(n,!0);try{let t=document.querySelectorAll("input[name='item_ids[]']:checked"),o=Array.from(t).map(a=>parseInt(a.value,10)).filter(Boolean),i=await u("/invoice/quoteitem/multiple",{item_ids:o}),r=l(i);r.success===1?(n.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>',location.reload()):(console.warn("quoteitem/multiple failed",r),p(n,!1,e))}catch(t){console.error("quoteitem/multiple error",t),p(n,!1,e),alert("An error occurred while deleting items. See console for details.")}}async handleAddRowModal(){let n=E(),e=`${location.origin}/invoice/quoteitem/add/${encodeURIComponent(n)}`,t=document.getElementById("modal-placeholder-quoteitem");if(t)try{t.innerHTML='<h2 class="text-center"><i class="fa fa-spin fa-spinner"></i></h2>';let i=await(await fetch(e,{cache:"no-store",credentials:"same-origin"})).text();t.innerHTML=i}catch(o){console.error("Failed to load quoteitem modal",o)}}handleAddQuoteItemRow(){let n=document.getElementById("new_quote_item_row"),e=document.getElementById("item_table");if(n&&e){let t=n.cloneNode(!0);t.removeAttribute("id"),t.classList.add("item"),t.style.display="",e.appendChild(t)}}handleAddGenericRow(){let n=document.getElementById("new_row"),e=document.getElementById("item_table");if(n&&e){let t=n.cloneNode(!0);t.removeAttribute("id"),t.classList.add("item"),t.style.display="",e.appendChild(t)}}async handleAddClientModal(){let n=`${location.origin}/invoice/add-a-client`,e=document.getElementById("modal-placeholder-client");if(e)try{e.innerHTML='<h2 class="text-center"><i class="fa fa-spin fa-spinner"></i></h2>';let o=await(await fetch(n,{cache:"no-store",credentials:"same-origin"})).text();e.innerHTML=o}catch(t){console.error("Failed to load add-a-client modal",t)}}async handleQuoteCreateConfirm(){let n=`${location.origin}/invoice/quote/create_confirm`,e=document.querySelector(".quote_create_confirm"),t=e?.innerHTML||"";e&&p(e,!0);try{let o={client_id:f("create_quote_client_id"),quote_group_id:f("quote_group_id"),quote_password:f("quote_password")},i=await u(n,o),r=l(i),a=new URL(location.href);r.success===1?(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),window.location.href=a.href,window.location.reload()):r.success===0&&(e&&(e.innerHTML='<h6 class="text-center"><i class="fa fa-check"></i></h6>'),window.location.href=a.href,window.location.reload(),r.message&&alert(r.message))}catch(o){console.error("create_confirm error",o),e&&p(e,!1,t),alert("An error occurred while creating quote. See console for details.")}}async handleQuotePurchaseOrderConfirm(n){let e=`${location.origin}/invoice/quote/approve`,t=document.querySelector(".quote_with_purchase_order_number_confirm")||n;t&&p(t,!0);try{let o={url_key:f("url_key"),client_po_number:f("quote_with_purchase_order_number"),client_po_person:f("quote_with_purchase_order_person")},i=await u(e,o),r=l(i),a=new URL(location.href);r.success===1&&(t&&(t.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),window.location.href=a.href,window.location.reload())}catch(o){console.error("approve error",o),t&&p(t,!1),alert("An error occurred while approving quote. See console for details.")}}async handleQuoteToInvoiceConfirm(n){let e=`${location.origin}/invoice/quote/quote_to_invoice_confirm`,t=document.querySelector(".quote_to_invoice_confirm")||n,o=t?.innerHTML||"";t&&p(t,!0);try{let r={quote_id:E(),client_id:f("client_id"),group_id:f("group_id"),password:f("password")},a=await u(e,r),c=l(a),d=new URL(location.href);t&&(t.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),window.location.href=d.href,window.location.reload(),c.flash_message&&alert(c.flash_message)}catch(i){console.error("quote_to_invoice_confirm error",i),t&&p(t,!1,o),alert("An error occurred while converting quote to invoice. See console for details.")}}async handleQuoteToSalesOrderConfirm(n){let e=`${location.origin}/invoice/quote/quote_to_so_confirm`,t=document.querySelector(".quote_to_so_confirm")||n,o=t?.innerHTML||"";t&&p(t,!0);try{let r={quote_id:E(),client_id:f("client_id"),group_id:f("so_group_id"),po_number:f("po_number"),po_person:f("po_person"),password:f("password")},a=await u(e,r),c=l(a),d=new URL(location.href);t&&(t.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),window.location.href=d.href,window.location.reload(),c.flash_message&&alert(c.flash_message)}catch(i){console.error("quote_to_so_confirm error",i),t&&p(t,!1,o),alert("An error occurred while converting quote to SO. See console for details.")}}async handleQuoteToQuoteConfirm(n){let e=`${location.origin}/invoice/quote/quote_to_quote_confirm`,t=document.querySelector(".quote_to_quote_confirm")||n,o=t?.innerHTML||"";t&&p(t,!0);try{let r={quote_id:E(),client_id:f("create_quote_client_id"),user_id:f("user_id")},a=await u(e,r),c=l(a),d=new URL(location.href);c.success===1&&(t&&(t.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),window.location.href=d.href,window.location.reload(),c.flash_message&&alert(c.flash_message))}catch(i){console.error("quote_to_quote_confirm error",i),t&&p(t,!1,o),alert("An error occurred while copying quote. See console for details.")}}handlePdfGeneration(n){if(n.closest("#quote_to_pdf_confirm_with_custom_fields")){let e=`${location.origin}/invoice/quote/pdf/1`;window.open(e,"_blank");return}if(n.closest("#quote_to_pdf_confirm_without_custom_fields")){let e=`${location.origin}/invoice/quote/pdf/0`;window.open(e,"_blank");return}}async handleClientNoteSave(n){if(!n.target.closest("#save_client_note"))return;let o=`${location.origin}/invoice/client/save_client_note`,i=`${location.origin}/invoice/client/load_client_notes`;try{let r={client_id:f("client_id"),client_note:f("client_note")},a=await u(o,r),c=l(a);if(c.success===1){document.querySelectorAll(".control-group").forEach(h=>{h.classList.remove("error")});let d=document.getElementById("client_note");d&&(d.value="");let m=document.getElementById("notes_list");if(m){let h=`${i}?client_id=${encodeURIComponent(r.client_id)}`,g=await(await fetch(h,{cache:"no-store",credentials:"same-origin"})).text();m.innerHTML=g}}else document.querySelectorAll(".control-group").forEach(d=>{d.classList.remove("error")}),c.validation_errors&&Object.keys(c.validation_errors).forEach(d=>{let m=document.getElementById(d);m?.parentElement&&m.parentElement.classList.add("has-error")})}catch(r){console.error("save_client_note error",r),alert("Status: error An error occurred")}}async handleQuoteTaxSubmit(n){let t=n.target.closest("#quote_tax_submit");if(!t)return;let o=`${location.origin}/invoice/quote/save_quote_tax_rate`,i=document.querySelector(".quote_tax_submit")||t;i&&p(i,!0);try{let a={quote_id:E(),tax_rate_id:f("tax_rate_id"),include_item_tax:f("include_item_tax")},c=await u(o,a),d=l(c),m=new URL(location.href);window.location.href=m.href,window.location.reload(),d.flash_message&&alert(d.flash_message)}catch(r){console.error("save_quote_tax_rate error",r),alert("An error occurred while saving quote tax rate. See console for details.")}}handleInput(n){let e=n.target;if(e.id==="quote_discount_amount"){let t=document.getElementById("quote_discount_percent");e.value.length>0?t&&(t.value="0.00",t.disabled=!0):t&&(t.disabled=!1)}if(e.id==="quote_discount_percent"){let t=document.getElementById("quote_discount_amount");e.value.length>0?t&&(t.value="0.00",t.disabled=!0):t&&(t.disabled=!1)}}handleFocus(n){let e=n.target;e.id==="datepicker"&&this.initializeDatepicker(e),e.classList?.contains("datepicker")&&this.initializeDatepicker(e),e.classList?.contains("taggable")&&(window.lastTaggableClicked=e)}initializeDatepicker(n){window.jQuery?.fn?.datepicker&&(n.id==="datepicker"?window.jQuery(n).datepicker({changeMonth:!0,changeYear:!0,showButtonPanel:!0,dateFormat:"dd-mm-yy"}):window.jQuery(n).datepicker({beforeShow:()=>{setTimeout(()=>{document.querySelectorAll(".datepicker").forEach(e=>{e.style.zIndex="9999"})},0)}}))}initializeComponents(){document.addEventListener("DOMContentLoaded",()=>{this.initializeTooltips(),this.initializeTagSelect()})}initializeTooltips(){typeof window.bootstrap?.Tooltip<"u"&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(n=>{try{new window.bootstrap.Tooltip(n)}catch{}})}initializeTagSelect(){document.querySelectorAll(".tag-select").forEach(n=>{n.addEventListener("change",t=>{let o=t.currentTarget;return window.lastTaggableClicked&&this.insertAtCaret(window.lastTaggableClicked.id,o.value),o._tomselect?.clear?o._tomselect.clear():o.tomselect?.clear?o.tomselect.clear():o.multiple?Array.from(o.options).forEach(i=>{i.selected=!1}):o.value="",t.preventDefault(),!1})})}insertAtCaret(n,e){let t=document.getElementById(n);if(!t)return;let o=t.selectionStart||0,i=t.selectionEnd||0,r=t.value;t.value=r.substring(0,o)+e+r.substring(i),t.setSelectionRange(o+e.length,o+e.length),t.focus()}};function L(s){return document.getElementById(s)?.value||""}function v(s,n,e){n?(s.innerHTML='<h6 class="text-center"><i class="fa fa-spin fa-spinner"></i></h6>',s.disabled=!0):(s.innerHTML=e||'<h6 class="text-center"><i class="fa fa-check"></i></h6>',s.disabled=!1)}var M=class{constructor(){this.bindEventListeners()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0)}handleClick(n){let e=n.target,t=e.closest("#client_create_confirm");if(t){this.handleClientCreateConfirm(t);return}let o=e.closest("#save_client_note_new");if(o){this.handleSaveClientNote(o);return}}async handleClientCreateConfirm(n){let e=`${location.origin}/invoice/client/create_confirm`,t=document.querySelector(".client_create_confirm")||n,o=new URL(location.href);t&&v(t,!0);try{let i={client_name:L("client_name"),client_surname:L("client_surname"),client_email:L("client_email")},r=await u(e,i),a=l(r);a.success===1?(t&&(t.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),window.location.href=o.href,window.location.reload()):(t&&v(t,!1),console.warn("create_confirm response",a))}catch(i){console.warn(i),t&&v(t,!1),alert("An error occurred while creating client. See console for details.")}}async handleSaveClientNote(n){let e=`${location.origin}/invoice/client/save_client_note_new`,t=`${location.origin}/invoice/client/load_client_notes`,o=document.querySelector(".save_client_note")||n,i=new URL(location.href);o&&v(o,!0);try{let r={client_id:L("client_id"),client_note:L("client_note")},a=await u(e,r),c=l(a);if(c.success===1){o&&(o.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>');let d=document.getElementById("client_note");d&&(d.value="");let m=document.getElementById("notes_list");if(m){let h=`${t}?client_id=${encodeURIComponent(r.client_id)}`;try{let g=await(await fetch(h,{cache:"no-store",credentials:"same-origin"})).text();m.innerHTML=g,console.log(g)}catch(_){console.error("load_client_notes failed",_)}}window.location.href=i.href,window.location.reload()}else this.clearValidationErrors(),c.validation_errors&&this.showValidationErrors(c.validation_errors),o&&v(o,!1)}catch(r){console.warn(r),o&&v(o,!1),alert("An error occurred while saving client note. See console for details.")}}clearValidationErrors(){document.querySelectorAll(".control-group").forEach(n=>{n.classList.remove("error")})}showValidationErrors(n){Object.keys(n).forEach(e=>{let t=document.getElementById(e);t?.parentElement&&t.parentElement.classList.add("has-error")})}};function b(s,n,e){n?(s.innerHTML='<h2 class="text-center"><i class="fa fa-spin fa-spinner"></i></h2>',s.disabled=!0):(s.innerHTML=e||'<h2 class="text-center"><i class="fa fa-check"></i></h2>',s.disabled=!1)}function x(s){return document.getElementById(s)?.value||""}var q=class{constructor(){this.bindEventListeners()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0)}handleClick(n){let e=n.target;if(T(e,"#btn-mark-as-sent")){this.handleMarkAsSent();return}if(T(e,"#btn-mark-sent-as-draft")){this.handleMarkSentAsDraft();return}let i=T(e,".create_recurring_confirm_multiple");if(i){this.handleCreateRecurringMultiple(i);return}}getCheckedInvoiceIds(){let n=[],e=document.getElementById("table-invoice");return e&&e.querySelectorAll('input[type="checkbox"]:checked').forEach(o=>{o.id&&n.push(o.id)}),n}async handleMarkAsSent(){let n=document.getElementById("btn-mark-as-sent"),e=n?.innerHTML;n&&b(n,!0);try{let t=this.getCheckedInvoiceIds(),o=`${location.origin}/invoice/inv/mark_as_sent`,i=await u(o,{keylist:t});l(i).success===1?(n&&(n.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),window.location.reload()):(n&&(n.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>'),window.location.reload())}catch(t){console.error("mark_as_sent error",t),n&&e&&b(n,!1,e),alert("An error occurred. See console for details.")}}async handleMarkSentAsDraft(){let n=document.getElementById("btn-mark-sent-as-draft"),e=n?.innerHTML;n&&b(n,!0);try{let t=this.getCheckedInvoiceIds(),o=`${location.origin}/invoice/inv/mark_sent_as_draft`,i=await u(o,{keylist:t});l(i).success===1?(n&&(n.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),window.location.reload()):(n&&(n.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>'),window.location.reload())}catch(t){console.error("mark_sent_as_draft error",t),n&&e&&b(n,!1,e),alert("An error occurred. See console for details.")}}async handleCreateRecurringMultiple(n){let e=document.querySelector(".create_recurring_confirm_multiple")||n,t=e?.innerHTML;e&&(e.innerHTML='<h6 class="text-center"><i class="fa fa-spin fa-spinner"></i></h6>',e.disabled=!0);try{let o=this.getCheckedInvoiceIds();if(o.length===0){alert("Please select invoices to create recurring invoices."),e&&t&&(e.innerHTML=t,e.disabled=!1);return}let i={keylist:o,recur_frequency:x("recur_frequency"),recur_start_date:x("recur_start_date"),recur_end_date:x("recur_end_date")};if(!i.recur_frequency||!i.recur_start_date){alert("Please select frequency and start date."),e&&t&&(e.innerHTML=t,e.disabled=!1);return}let r=`${location.origin}/invoice/invrecurring/multiple`,a=await u(r,i);l(a).success===1?(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),this.closeModal("create-recurring-multiple"),setTimeout(()=>{window.location.reload()},500)):(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>'),alert("Failed to create recurring invoices. Please try again."),e&&t&&(e.innerHTML=t,e.disabled=!1))}catch(o){console.error("invrecurring/multiple error",o),e&&t&&(e.innerHTML=t,e.disabled=!1),alert("An error occurred while creating recurring invoices. See console for details.")}}closeModal(n){try{if(typeof window.bootstrap?.Modal<"u"){let e=document.getElementById(n);if(e){let t=window.bootstrap.Modal.getInstance(e);t&&t.hide()}}}catch(e){console.warn("Failed to close modal:",e)}}};function P(s,n){s.forEach(e=>{n?e.innerHTML='<h6 class="text-center"><i class="fa fa-spin fa-spinner"></i></h6>':e.innerHTML='<h6 class="text-center"><i class="fa fa-check"></i></h6>'})}function F(s){s.forEach(n=>{n.innerHTML='<h6 class="text-center"><i class="fa fa-error"></i></h6>'})}var I=class{constructor(){this.bindEventListeners(),this.exposeGlobalFunctions()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0)}handleClick(n){n.target.closest("#product_filters_submit")&&this.submitProductFilters(n)}filterTableBySku(){let n=document.getElementById("filter_product_sku");if(!n)return;let t=(n.value||"").toUpperCase(),o=document.getElementById("table-product");if(!o)return;let i=o.getElementsByTagName("tr");for(let r=0;r<i.length;r++){let a=i[r].getElementsByTagName("td")[2];a&&((a.textContent||a.innerText||"").toUpperCase().indexOf(t)>-1?i[r].style.display="":i[r].style.display="none")}}async submitProductFilters(n){n?.preventDefault&&n.preventDefault();let e=`${location.origin}/invoice/product/search`,t=document.querySelectorAll(".product_filters_submit");P(t,!0);try{let r={product_sku:document.getElementById("filter_product_sku")?.value||""},a=await u(e,r),c=l(a);c.success===1?(this.filterTableBySku(),this.hideSummaryBar(),P(t,!1)):(F(t),c.message&&alert(c.message))}catch(o){console.error("product search failed",o),F(t),alert("An error occurred while searching products. See console for details.")}}hideSummaryBar(){let n=document.querySelector(".mt-3.me-3.summary.text-end");n&&(n.style.visibility="hidden")}exposeGlobalFunctions(){window.productTableFilter=this.filterTableBySku.bind(this)}};var k=class{constructor(){this.bindEventListeners(),this.initializeOnLoad()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0)}initializeOnLoad(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.initSelects()}):this.initSelects()}handleClick(n){let e=n.target,t=e.closest(".open-salesorder-modal");if(t){this.handleOpenModal(t);return}if(e.closest(".salesorder-save")){this.handleSaveSalesOrder();return}}initSelects(){if(typeof window.TomSelect>"u")return;document.querySelectorAll(".simple-select").forEach(e=>{if(!e._tomselect)try{new window.TomSelect(e,{}),e._tomselect=!0}catch(t){console.warn("Failed to initialize TomSelect:",t)}})}async handleOpenModal(n){let e=n.dataset.url||`${location.origin}/invoice/salesorder/modal`,t=n.dataset.target||"modal-placeholder-salesorder",o=document.getElementById(t);if(!o){console.error(`Modal target element not found: ${t}`);return}try{let r=await(await fetch(e,{cache:"no-store",credentials:"same-origin"})).text();o.innerHTML=r;let a=o.querySelector(".modal");a&&window.bootstrap?.Modal&&new window.bootstrap.Modal(a).show(),this.initSelects()}catch(i){console.error("Failed to load sales order modal:",i),alert("Failed to load modal. Please try again.")}}async handleSaveSalesOrder(){let n=document.querySelector("#salesorder_form");if(!n){console.error("Sales order form not found");return}try{let e=n.getAttribute("action")||`${location.origin}/invoice/salesorder/save`,t=new FormData(n),o=new URLSearchParams;t.forEach((d,m)=>{o.append(m,d.toString())});let i=`${e}?${o.toString()}`,a=await(await fetch(i,{cache:"no-store",credentials:"same-origin",headers:{Accept:"application/json"}})).json(),c=l(a);if(c.success===1)window.location.reload();else{let d=c.message||"Save failed";alert(d)}}catch(e){console.error("Sales order save failed:",e),alert("An error occurred while saving. Please try again.")}}};var R=class{constructor(){this.bindEventListeners()}bindEventListeners(){document.addEventListener("DOMContentLoaded",this.initializeSelectors.bind(this))}initializeSelectors(){let n=document.getElementById("family-category-primary-id"),e=document.getElementById("family-category-secondary-id");n&&(n.addEventListener("change",this.onPrimaryChange.bind(this),!1),Promise.resolve().then(()=>this.onPrimaryChange())),e&&(e.addEventListener("change",this.onSecondaryChange.bind(this),!1),Promise.resolve().then(()=>this.onSecondaryChange()))}populateSelect(n,e,t){if(!n)return;n.innerHTML="";let o=document.createElement("option");o.value="",o.textContent=t||"None",n.appendChild(o),e&&(Array.isArray(e)?e.forEach((i,r)=>{let a=document.createElement("option");a.value=r.toString(),a.textContent=i,n.appendChild(a)}):Object.entries(e).forEach(([i,r])=>{let a=document.createElement("option");a.value=i,a.textContent=r,n.appendChild(a)}))}async onPrimaryChange(){let n=document.getElementById("family-category-primary-id");if(!n)return;let e=n.value||"",t=`${location.origin}/invoice/family/secondaries/${encodeURIComponent(e)}`;try{let i=await u(t,{category_primary_id:e}),r=l(i);if(r.success===1){let a=r.secondary_categories||{},c=document.getElementById("family-category-secondary-id");if(this.populateSelect(c,a,"None"),c){let d=new Event("change",{bubbles:!0});c.dispatchEvent(d)}}else this.populateSelect(document.getElementById("family-category-secondary-id"),{},"None"),this.populateSelect(document.getElementById("family-name"),{},"None")}catch(o){console.error("Error loading secondary categories",o),this.populateSelect(document.getElementById("family-category-secondary-id"),{},"None"),this.populateSelect(document.getElementById("family-name"),{},"None")}}async onSecondaryChange(){let n=document.getElementById("family-category-secondary-id");if(!n)return;let e=n.value||"",t=`${location.origin}/invoice/family/names/${encodeURIComponent(e)}`;try{let i=await u(t,{category_secondary_id:e}),r=l(i);if(r.success===1){let a=r.family_names||{},c=document.getElementById("family-name");this.populateSelect(c,a,"None")}else this.populateSelect(document.getElementById("family-name"),{},"None")}catch(o){console.error("Error loading family names",o),this.populateSelect(document.getElementById("family-name"),{},"None")}}};var C=class{constructor(){this.originalDisplayStyles={};this.originalDisabledStates={};this.bindEventListeners()}bindEventListeners(){document.addEventListener("DOMContentLoaded",this.initialize.bind(this))}initialize(){this.toggleSmtpSettings();let n=document.getElementById("email_send_method");n&&n.addEventListener("change",this.toggleSmtpSettings.bind(this));let e=document.getElementById("btn_fph_generate");e&&e.addEventListener("click",r=>{r.preventDefault(),this.handleFphGenerateClick()});let t=document.getElementById("btn_generate_cron_key");t&&t.addEventListener("click",r=>{r.preventDefault(),this.handleGenerateCronKeyClick()});let o=document.getElementById("btn-submit");o&&o.addEventListener("click",r=>{r.preventDefault(),this.handleSettingsSubmitClick()});let i=document.getElementById("online-payment-select");i&&i.addEventListener("change",this.handleOnlinePaymentSelectChange.bind(this)),this.handleOnlinePaymentSelectChange()}toggleSmtpSettings(){let n=document.getElementById("email_send_method"),e=document.getElementById("div-smtp-settings");!e||!n||(n.value==="smtp"?e.style.display="":e.style.display="none")}async handleFphGenerateClick(){let n=`${location.origin}/invoice/setting/fphgenerate`,e={userAgent:navigator.userAgent,width:window.screen.width,height:window.screen.height,scalingFactor:Math.round(window.devicePixelRatio*100)/100,colourDepth:window.screen.colorDepth,windowInnerWidth:window.innerWidth,windowInnerHeight:window.innerHeight},t=new URLSearchParams;Object.entries(e).forEach(([o,i])=>{t.append(o,i.toString())});try{let o=await fetch(`${n}?${t.toString()}`,{method:"GET",credentials:"same-origin",cache:"no-store",headers:{Accept:"application/json"}});if(!o.ok)throw new Error(`Network response not ok: ${o.status}`);let i=await o.json().catch(()=>({})),r=l(i);r.success===1&&(this.updateSettingField("settings[fph_client_browser_js_user_agent]",r.userAgent),this.updateSettingField("settings[fph_client_device_id]",r.deviceId),this.updateSettingField("settings[fph_screen_width]",r.width),this.updateSettingField("settings[fph_screen_height]",r.height),this.updateSettingField("settings[fph_screen_scaling_factor]",r.scalingFactor),this.updateSettingField("settings[fph_screen_colour_depth]",r.colourDepth),this.updateSettingField("settings[fph_timestamp]",r.timestamp),this.updateSettingField("settings[fph_window_size]",r.windowSize),this.updateSettingField("settings[fph_gov_client_user_id]",r.userUuid))}catch(o){console.error("FPH generate failed",o)}}updateSettingField(n,e){let t=document.getElementById(n);t&&e!==void 0&&(t.value=e)}async handleGenerateCronKeyClick(){let n=document.querySelectorAll(".btn_generate_cron_key");n.forEach(e=>{e.innerHTML='<i class="fa fa-spin fa-spinner fa-margin"></i>'});try{let e=`${location.origin}/invoice/setting/get_cron_key`,t=await fetch(e,{method:"GET",credentials:"same-origin",cache:"no-store",headers:{Accept:"application/json"}});if(!t.ok)throw new Error(`Network response not ok: ${t.status}`);let o=await t.json().catch(()=>({})),i=l(o);i.success===1&&i.cronkey&&document.querySelectorAll(".cron_key").forEach(a=>{a.value=i.cronkey||""}),n.forEach(r=>{r.innerHTML='<i class="fa fa-recycle fa-margin"></i>'})}catch(e){console.error("get_cron_key failed",e),n.forEach(t=>{t.innerHTML='<i class="fa fa-recycle fa-margin"></i>'})}}handleSettingsSubmitClick(){let n=document.getElementById("form-settings");if(!n)return;let e=n.querySelectorAll(".tab-pane");this.originalDisplayStyles={},this.originalDisabledStates={},e.forEach(t=>{t.id&&(this.originalDisplayStyles[t.id]=t.style.display,t.style.display="block",t.querySelectorAll("input:disabled, select:disabled, textarea:disabled").forEach((i,r)=>{let a=`${t.id}_${r}`;this.originalDisabledStates[a]={element:i,disabled:!0},i.disabled=!1}))}),setTimeout(()=>{n.submit(),this.restoreFormState(e)},10)}restoreFormState(n){n.forEach(e=>{e.id&&this.originalDisplayStyles[e.id]!==void 0&&(e.style.display=this.originalDisplayStyles[e.id])}),Object.entries(this.originalDisabledStates).forEach(([e,t])=>{t.element&&t.disabled&&(t.element.disabled=!0)})}handleOnlinePaymentSelectChange(){let n=document.getElementById("online-payment-select");if(!n)return;let e=n.value;document.querySelectorAll(".gateway-settings").forEach(i=>{i.classList.contains("active-gateway")||i.classList.add("hidden")});let o=document.getElementById(`gateway-settings-${e}`);o&&(o.classList.remove("hidden"),o.classList.add("active-gateway"))}};var w=class{constructor(){this._createCreditHandler=new H,this._quoteHandler=new S,this._clientHandler=new M,this._invoiceHandler=new q,this._productHandler=new I,this._salesOrderHandler=new k,this._familyHandler=new R,this._settingsHandler=new C,this.initializeTooltips(),this.initializeTaggableFocus(),console.log("Invoice TypeScript App initialized with all core handlers: Quote, Client, Invoice, Product, SalesOrder, Family, and Settings")}initializeTooltips(){document.addEventListener("DOMContentLoaded",()=>{typeof bootstrap<"u"&&bootstrap.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(e=>{try{new bootstrap.Tooltip(e)}catch(t){console.warn("Tooltip initialization failed:",t)}})})}initializeTaggableFocus(){document.addEventListener("focus",n=>{let e=n.target;e?.classList?.contains("taggable")&&(window.lastTaggableClicked=e)},!0)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>new w):new w;return Q(j);})();
