"use strict";var InvoiceApp=(()=>{var O=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var ee=Object.prototype.hasOwnProperty;var te=(a,t)=>{for(var e in t)O(a,e,{get:t[e],enumerable:!0})},ne=(a,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Z(t))!ee.call(a,o)&&o!==e&&O(a,o,{get:()=>t[o],enumerable:!(n=Y(t,o))||n.enumerable});return a};var oe=a=>ne(O({},"__esModule",{value:!0}),a);var de={};te(de,{InvoiceApp:()=>S});function m(a){if(!a)return{};if(typeof a=="object"&&a!==null)return a;if(typeof a=="string")try{return JSON.parse(a)}catch{return{}}return{}}async function p(a,t,e={}){let n=a;if(t){let r=new URLSearchParams;Object.entries(t).forEach(([c,u])=>{Array.isArray(u)?u.forEach(d=>{d!=null&&r.append(`${c}[]`,String(d))}):u!=null&&r.append(c,String(u))});let l=a.includes("?")?"&":"?";n=`${a}${l}${r.toString()}`}let o={method:"GET",credentials:"same-origin",cache:"no-store",headers:{Accept:"application/json"},...e},s=await fetch(n,o);if(!s.ok)throw new Error(`Network response not ok: ${s.status}`);let i=await s.text();try{return JSON.parse(i)}catch{return i}}function g(a,t){try{if(!a)return null;if(typeof a.closest=="function")return a.closest(t);let e=a;for(;e;){if(e.matches&&e.matches(t))return e;e=e.parentElement}}catch(e){return console.warn("closestSafe error:",e),null}return null}function ie(a){return document.getElementById(a)}function V(a){return document.querySelector(a)}function M(a){return ie(a)?.value||""}var k=class{confirmButtonSelector=".create-credit-confirm";constructor(){this.initialize()}initialize(){document.addEventListener("click",this.handleClick.bind(this),!0)}async handleClick(t){let e=t.target;if(!(!e||e.id!=="create-credit-confirm")){t.preventDefault();try{await this.processCreateCredit()}catch(n){console.error("Create credit error:",n),alert(`Error: ${n instanceof Error?n.message:"Unknown error"}`)}}}async processCreateCredit(){let t=`${location.origin}/invoice/inv/create_credit_confirm`,e=V(this.confirmButtonSelector),n=new URL(location.href);e&&(e.innerHTML='<h6 class="text-center"><i class="fa fa-spin fa-spinner"></i></h6>');let s={inv_id:n.pathname.split("/").at(-1)||"",client_id:M("client_id"),inv_date_created:M("inv_date_created"),group_id:M("inv_group_id"),password:M("inv_password"),user_id:M("user_id")},i=await p(t,s),r=m(i);r.success===1?(e&&(e.innerHTML='<h2 class="text-center"><i class="bi bi-check2-square"></i></h2>'),r.flash_message&&alert(r.flash_message),location.href=n.href,location.reload()):(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>'),r.flash_message&&alert(r.flash_message),location.href=n.href,location.reload())}};function w(){window.location.reload()}function N(a,t){let n=new DOMParser().parseFromString(t,"text/html"),o=document.createDocumentFragment();Array.from(n.body.children).forEach(s=>o.appendChild(s)),a.innerHTML="",a.appendChild(o)}function b(){return new URL(location.href).pathname.split("/").at(-1)||""}function v(a){return document.getElementById(a)?.value||""}function _(a,t,e){t?(a.innerHTML='<h6 class="text-center"><i class="fa fa-spin fa-spinner"></i></h6>',a.disabled=!0):(a.innerHTML=e||'<h6 class="text-center"><i class="fa fa-check"></i></h6>',a.disabled=!1)}var I=class{constructor(){this.bindEventListeners(),this.initializeComponents()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0),document.addEventListener("input",this.handleInput.bind(this),!0),document.addEventListener("focus",this.handleFocus.bind(this),!0),document.addEventListener("click",this.handleClientNoteSave.bind(this),!0),document.addEventListener("click",this.handleQuoteTaxSubmit.bind(this),!0)}handleClick(t){let e=t.target,n=e.closest(".btn_delete_item");if(n){this.handleDeleteItem(n);return}let o=e.closest(".delete-items-confirm-quote");if(o){this.handleDeleteMultipleItems(o);return}if(e.closest(".btn_add_row_modal")){this.handleAddRowModal();return}if(e.closest(".btn_quote_item_add_row")){this.handleAddQuoteItemRow();return}if(e.closest(".btn_add_row")){this.handleAddGenericRow();return}if(e.closest(".quote_add_client")){this.handleAddClientModal();return}if(e.closest("#quote_create_confirm, .quote_create_confirm")){this.handleQuoteCreateConfirm();return}let u=e.closest("#quote_with_purchase_order_number_confirm, .quote_with_purchase_order_number_confirm");if(u){this.handleQuotePurchaseOrderConfirm(u);return}let d=e.closest("#quote_to_invoice_confirm, .quote_to_invoice_confirm");if(d){this.handleQuoteToInvoiceConfirm(d);return}let f=e.closest("#quote_to_so_confirm, .quote_to_so_confirm");if(f){this.handleQuoteToSalesOrderConfirm(f);return}let h=e.closest("#quote_to_quote_confirm, .quote_to_quote_confirm");if(h){this.handleQuoteToQuoteConfirm(h);return}this.handlePdfGeneration(e)}async handleDeleteItem(t){let e=t.getAttribute("data-id");if(!e){t.closest(".item")?.remove();return}try{let n=`${location.origin}/invoice/quote/delete_item/${encodeURIComponent(e)}`,o=await p(n,{id:e}),s=m(o);s.success===1?(location.reload(),t.closest(".item")?.remove(),alert("Deleted")):console.warn("delete_item failed",s)}catch(n){console.error("delete_item error",n),alert("An error occurred while deleting item. See console for details.")}}async handleDeleteMultipleItems(t){let e=t.innerHTML;_(t,!0);try{let n=document.querySelectorAll("input[name='item_ids[]']:checked"),o=Array.from(n).map(r=>parseInt(r.value,10)).filter(Boolean).toSorted((r,l)=>r-l),s=await p("/invoice/quoteitem/multiple",{item_ids:o}),i=m(s);i.success===1?(t.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>',location.reload()):(console.warn("quoteitem/multiple failed",i),_(t,!1,e))}catch(n){console.error("quoteitem/multiple error",n),_(t,!1,e),alert("An error occurred while deleting items. See console for details.")}}async handleAddRowModal(){let t=b(),e=`${location.origin}/invoice/quoteitem/add/${encodeURIComponent(t)}`,n=document.getElementById("modal-placeholder-quoteitem");if(n)try{n.innerHTML='<h2 class="text-center"><i class="fa fa-spin fa-spinner"></i></h2>';let s=await(await fetch(e,{cache:"no-store",credentials:"same-origin"})).text();N(n,s)}catch(o){console.error("Failed to load quoteitem modal",o)}}handleAddQuoteItemRow(){let t=document.getElementById("new_quote_item_row"),e=document.getElementById("item_table");if(t&&e){let n=t.cloneNode(!0);n.removeAttribute("id"),n.classList.add("item"),n.style.display="",e.appendChild(n)}}handleAddGenericRow(){let t=document.getElementById("new_row"),e=document.getElementById("item_table");if(t&&e){let n=t.cloneNode(!0);n.removeAttribute("id"),n.classList.add("item"),n.style.display="",e.appendChild(n)}}async handleAddClientModal(){let t=`${location.origin}/invoice/add-a-client`,e=document.getElementById("modal-placeholder-client");if(e)try{e.innerHTML='<h2 class="text-center"><i class="fa fa-spin fa-spinner"></i></h2>';let o=await(await fetch(t,{cache:"no-store",credentials:"same-origin"})).text();N(e,o)}catch(n){console.error("Failed to load add-a-client modal",n)}}async handleQuoteCreateConfirm(){let t=`${location.origin}/invoice/quote/create_confirm`,e=document.querySelector(".quote_create_confirm"),n=e?.innerHTML||"";e&&_(e,!0);try{let o={client_id:v("create_quote_client_id"),quote_group_id:v("quote_group_id"),quote_password:v("quote_password")},s=await p(t,o),i=m(s);i.success===1?(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),w()):i.success===0&&(e&&(e.innerHTML='<h6 class="text-center"><i class="fa fa-check"></i></h6>'),w(),i.message&&alert(i.message))}catch(o){console.error("create_confirm error",o),e&&_(e,!1,n),alert("An error occurred while creating quote. See console for details.")}}async handleQuotePurchaseOrderConfirm(t){let e=`${location.origin}/invoice/quote/approve`,n=document.querySelector(".quote_with_purchase_order_number_confirm")||t;n&&_(n,!0);try{let o={url_key:v("url_key"),client_po_number:v("quote_with_purchase_order_number"),client_po_person:v("quote_with_purchase_order_person")},s=await p(e,o);m(s).success===1&&(n&&(n.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),w())}catch(o){console.error("approve error",o),n&&_(n,!1),alert("An error occurred while approving quote. See console for details.")}}async handleQuoteToInvoiceConfirm(t){let e=`${location.origin}/invoice/quote/quote_to_invoice_confirm`,n=document.querySelector(".quote_to_invoice_confirm")||t,o=n?.innerHTML||"";n&&_(n,!0);try{let i={quote_id:b(),client_id:v("client_id"),group_id:v("group_id"),password:v("password")},r=await p(e,i),l=m(r);n&&(n.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),l.success&&l.new_invoice_id?window.location.href=`${location.origin}/invoice/inv/view/${l.new_invoice_id}`:w(),l.flash_message&&alert(l.flash_message)}catch(s){console.error("quote_to_invoice_confirm error",s),n&&_(n,!1,o),alert("An error occurred while converting quote to invoice. See console for details.")}}async handleQuoteToSalesOrderConfirm(t){let e=`${location.origin}/invoice/quote/quote_to_so_confirm`,n=document.querySelector(".quote_to_so_confirm")||t,o=n?.innerHTML||"";n&&_(n,!0);try{let i={quote_id:b(),client_id:v("client_id"),group_id:v("so_group_id"),po_number:v("po_number"),po_person:v("po_person"),password:v("password")},r=await p(e,i),l=m(r);n&&(n.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),w(),l.flash_message&&alert(l.flash_message)}catch(s){console.error("quote_to_so_confirm error",s),n&&_(n,!1,o),alert("An error occurred while converting quote to SO. See console for details.")}}async handleQuoteToQuoteConfirm(t){let e=`${location.origin}/invoice/quote/quote_to_quote_confirm`,n=document.querySelector(".quote_to_quote_confirm")||t,o=n?.innerHTML||"";n&&_(n,!0);try{let i={quote_id:b(),client_id:v("create_quote_client_id"),user_id:v("user_id")},r=await p(e,i),l=m(r);l.success===1&&(n&&(n.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),w(),l.flash_message&&alert(l.flash_message))}catch(s){console.error("quote_to_quote_confirm error",s),n&&_(n,!1,o),alert("An error occurred while copying quote. See console for details.")}}handlePdfGeneration(t){if(t.closest("#quote_to_pdf_confirm_with_custom_fields")){let e=`${location.origin}/invoice/quote/pdf/1`;window.open(e,"_blank");return}if(t.closest("#quote_to_pdf_confirm_without_custom_fields")){let e=`${location.origin}/invoice/quote/pdf/0`;window.open(e,"_blank");return}}async handleClientNoteSave(t){if(!t.target.closest("#save_client_note"))return;let o=`${location.origin}/invoice/client/save_client_note`,s=`${location.origin}/invoice/client/load_client_notes`;try{let i={client_id:v("client_id"),client_note:v("client_note")},r=await p(o,i),l=m(r);if(l.success===1){document.querySelectorAll(".control-group").forEach(d=>{d.classList.remove("error")});let c=document.getElementById("client_note");c&&(c.value="");let u=document.getElementById("notes_list");if(u){let d=`${s}?client_id=${encodeURIComponent(i.client_id)}`,h=await(await fetch(d,{cache:"no-store",credentials:"same-origin"})).text();N(u,h)}}else document.querySelectorAll(".control-group").forEach(c=>{c.classList.remove("error")}),l.validation_errors&&Object.entries(l.validation_errors).forEach(([c,u])=>{let d=document.getElementById(c);d?.parentElement&&d.parentElement.classList.add("has-error")})}catch(i){console.error("save_client_note error",i),alert("Status: error An error occurred")}}async handleQuoteTaxSubmit(t){let n=t.target.closest("#quote_tax_submit");if(!n)return;let o=`${location.origin}/invoice/quote/save_quote_tax_rate`,s=document.querySelector(".quote_tax_submit")||n;s&&_(s,!0);try{let r={quote_id:b(),tax_rate_id:v("tax_rate_id"),include_item_tax:v("include_item_tax")},l=await p(o,r),c=m(l);w(),c.flash_message&&alert(c.flash_message)}catch(i){console.error("save_quote_tax_rate error",i),alert("An error occurred while saving quote tax rate. See console for details.")}}handleInput(t){let e=t.target;if(e.id==="quote_discount_amount"){let n=document.getElementById("quote_discount_percent");e.value.length>0?n&&(n.value="0.00",n.disabled=!0):n&&(n.disabled=!1)}if(e.id==="quote_discount_percent"){let n=document.getElementById("quote_discount_amount");e.value.length>0?n&&(n.value="0.00",n.disabled=!0):n&&(n.disabled=!1)}}handleFocus(t){let e=t.target;e.id==="datepicker"&&this.initializeDatepicker(e),e.classList?.contains("datepicker")&&this.initializeDatepicker(e),e.classList?.contains("taggable")&&(window.lastTaggableClicked=e)}initializeDatepicker(t){window.jQuery?.fn?.datepicker&&(t.id==="datepicker"?window.jQuery(t).datepicker({changeMonth:!0,changeYear:!0,showButtonPanel:!0,dateFormat:"dd-mm-yy"}):window.jQuery(t).datepicker({beforeShow:()=>{setTimeout(()=>{document.querySelectorAll(".datepicker").forEach(e=>{e.style.zIndex="9999"})},0)}}))}initializeComponents(){document.addEventListener("DOMContentLoaded",()=>{this.initializeTooltips(),this.initializeTagSelect()})}initializeTooltips(){typeof window.bootstrap?.Tooltip<"u"&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(t=>{try{new window.bootstrap.Tooltip(t)}catch{}})}initializeTagSelect(){document.querySelectorAll(".tag-select").forEach(t=>{t.addEventListener("change",n=>{let o=n.currentTarget;return window.lastTaggableClicked&&this.insertAtCaret(window.lastTaggableClicked.id,o.value),o._tomselect?.clear?o._tomselect.clear():o.tomselect?.clear?o.tomselect.clear():o.multiple?Array.from(o.options).toReversed().forEach(s=>{s.selected=!1}):o.value="",n.preventDefault(),!1})})}insertAtCaret(t,e){let n=document.getElementById(t);if(!n)return;let o=n.selectionStart||0,s=n.selectionEnd||0,i=n.value;n.value=i.substring(0,o)+e+i.substring(s),n.setSelectionRange(o+e.length,o+e.length),n.focus()}};function H(a){return document.getElementById(a)?.value||""}function se(){window.location.reload()}function x(a="h6",t="text-center",e="fa fa-spin fa-spinner"){let n=document.createElement(a);n.className=t;let o=document.createElement("i");return o.className=e,n.appendChild(o),n}function T(a,t,e){t?(a.textContent="",a.appendChild(x("h6","text-center","fa fa-spin fa-spinner")),a.disabled=!0):(a.textContent="",a.appendChild(x("h6","text-center","fa fa-check")),a.disabled=!1)}function J(a,t="h6",e="text-center",n="fa fa-spin fa-spinner"){a&&(a.textContent="",a.appendChild(x(t,e,n)))}var C=class{constructor(){this.bindEventListeners()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0),this.bindSpecificFormHandlers()}bindSpecificFormHandlers(){let t=(e,n)=>{let o=document.getElementById(e);o?o.addEventListener("submit",n.bind(this)):document.addEventListener("DOMContentLoaded",()=>{let s=document.getElementById(e);s&&s.addEventListener("submit",n.bind(this))})};t("QuoteForm",this.handleQuoteFormSubmit),t("InvForm",this.handleInvoiceFormSubmit)}handleClick(t){let e=t.target,n=e.closest("#client_create_confirm");if(n){this.handleClientCreateConfirm(n);return}let o=e.closest("#save_client_note_new");if(o){this.handleSaveClientNote(o);return}let s=e.closest(".client-note-delete-btn");if(s){this.handleDeleteClientNote(s);return}}async handleClientCreateConfirm(t){let e=`${location.origin}/invoice/client/create_confirm`,n=document.querySelector(".client_create_confirm")||t;n&&T(n,!0);try{let o={client_name:H("client_name"),client_surname:H("client_surname"),client_email:H("client_email")},s=await p(e,o),i=m(s);i.success===1?(n&&J(n,"h2","text-center","fa fa-check"),se()):(n&&T(n,!1),console.warn("create_confirm response",i))}catch(o){console.warn(o),n&&T(n,!1),alert("An error occurred while creating client. See console for details.")}}async handleSaveClientNote(t){let e=`${location.origin}/invoice/client/save_client_note_new`,n=`${location.origin}/invoice/client/load_client_notes`,o=document.querySelector(".save_client_note")||t,s=new URL(location.href);o&&T(o,!0);try{let i={client_id:H("client_id"),client_note:H("client_note")},r=await p(e,i),l=m(r);if(l.success===1){o&&J(o,"h2","text-center","fa fa-check");let c=document.getElementById("client_note");c&&(c.value="");let u=document.getElementById("notes_list");if(u){let d=`${n}?client_id=${encodeURIComponent(i.client_id)}`;try{let h=await(await fetch(d,{cache:"no-store",credentials:"same-origin"})).text();if(h&&!h.includes("<!DOCTYPE")&&!h.includes("<html")){u.textContent="";let E=new DOMParser;try{let L=E.parseFromString(h,"text/html");if(L&&L.body){let $=document.createDocumentFragment();for(;L.body.firstChild;)$.appendChild(L.body.firstChild);u.appendChild($)}}catch(L){console.error("HTML parsing error:",L),u.textContent="Error loading notes"}}else{console.warn("Received full page HTML instead of notes fragment, reloading page"),window.location.reload();return}}catch(f){console.error("load_client_notes failed",f),window.location.reload();return}}setTimeout(()=>{o&&T(o,!1,'<h6 class="text-center"><i class="fa fa-save"></i></h6>')},1e3)}else this.clearValidationErrors(),l.validation_errors&&this.showValidationErrors(l.validation_errors),o&&T(o,!1)}catch(i){console.warn(i),o&&T(o,!1),alert("An error occurred while saving client note. See console for details.")}}async handleDeleteClientNote(t){let e=t.getAttribute("data-note-id");if(!e){console.error("No note ID found on delete button");return}if(!confirm("Are you sure you want to delete this note?"))return;let n=`${location.origin}/invoice/client/delete_client_note`,o=t.innerHTML;try{t.textContent="";let s=document.createElement("i");s.className="fa fa-spin fa-spinner",t.appendChild(s),t.disabled=!0;let i=await fetch(`${n}?note_id=${encodeURIComponent(e)}`,{method:"GET",credentials:"same-origin"});if(i.ok){let r=await i.json();if(r.success===1){let l=t.closest(".panel");l&&l.remove()}else t.innerHTML=o,t.disabled=!1,alert(r.message||"Failed to delete note. Please try again.")}else{let r=await i.text();console.error("Delete client note HTTP error:",{status:i.status,statusText:i.statusText,body:r.substring(0,500)}),t.innerHTML=o,t.disabled=!1,alert("Failed to delete note. Please try again.")}}catch(s){console.error("Delete client note error:",s),t.innerHTML=o,t.disabled=!1,alert("An error occurred while deleting the note. Please try again.")}}clearValidationErrors(){document.querySelectorAll(".control-group").forEach(t=>{t.classList.remove("error")})}showValidationErrors(t){Object.entries(t).forEach(([e,n])=>{let o=document.getElementById(e);o?.parentElement&&o.parentElement.classList.add("has-error")})}async handleQuoteFormSubmit(t){t.preventDefault();let e=t.target,n=e.querySelector('button[type="submit"]'),o=n?.innerHTML;if(n&&T(n,!0),n){n.textContent="";let i=document.createElement("i");i.className="fa fa-check",n.appendChild(i)}let s=document.getElementById("modal-add-quote")||document.getElementById("modal-add-client");if(s){let i=window.bootstrap?.Modal?.getInstance(s);i&&i.hide()}setTimeout(()=>{e.submit()},300)}async handleInvoiceFormSubmit(t){t.preventDefault();let e=t.target,n=e.querySelector('button[type="submit"]'),o=n?.innerHTML;if(n&&T(n,!0),n){n.textContent="";let i=document.createElement("i");i.className="fa fa-check",n.appendChild(i)}let s=document.getElementById("modal-add-inv")||document.getElementById("modal-add-client");if(s){let i=window.bootstrap?.Modal?.getInstance(s);i&&i.hide()}setTimeout(()=>{e.submit()},300)}};function q(a,t,e){t?(a.innerHTML='<h2 class="text-center"><i class="fa fa-spin fa-spinner"></i></h2>',a.disabled=!0):(a.innerHTML=e||'<h2 class="text-center"><i class="fa fa-check"></i></h2>',a.disabled=!1)}function y(a){return document.getElementById(a)?.value||""}var R=class{constructor(){this.bindEventListeners()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0),document.addEventListener("change",this.handleChange.bind(this),!0),this.initializeAllClientsCheck()}handleChange(t){let e=t.target,n=e.closest('[name="checkbox-selection-all"]');if(n){this.handleSelectAllCheckboxes(n.checked);return}if(e.closest("#user_all_clients")){this.handleAllClientsCheck();return}}handleClick(t){let e=t.target;if(g(e,"#btn-mark-as-sent")){this.handleMarkAsSent();return}if(g(e,"#btn-mark-sent-as-draft")){this.handleMarkSentAsDraft();return}let s=g(e,".create_recurring_confirm_multiple");if(s){this.handleCreateRecurringMultiple(s);return}let i=g(e,".delete-items-confirm-inv")||g(e,"#delete-items-confirm-inv");if(i){this.handleDeleteInvoiceItems(i);return}let r=g(e,".modal_copy_inv_multiple_confirm");if(r){this.handleCopyMultipleInvoices(r);return}let l=g(e,"#inv_to_inv_confirm")||g(e,".inv_to_inv_confirm");if(l){this.handleCopySingleInvoice(l);return}let c=g(e,"#inv_tax_submit");if(c){t.preventDefault(),this.handleAddInvoiceTax(c);return}if(g(e,"#inv_to_pdf_confirm_with_custom_fields")){this.handlePdfExport(!0);return}if(g(e,"#inv_to_pdf_confirm_without_custom_fields")){this.handlePdfExport(!1);return}if(g(e,"#inv_to_modal_pdf_confirm_with_custom_fields")){this.handleModalPdfView(!0);return}if(g(e,"#inv_to_modal_pdf_confirm_without_custom_fields")){this.handleModalPdfView(!1);return}if(g(e,"#inv_to_html_confirm_with_custom_fields")){this.handleHtmlExport(!0);return}if(g(e,"#inv_to_html_confirm_without_custom_fields")){this.handleHtmlExport(!1);return}if(g(e,"#btn_modal_payment_submit")){this.handlePaymentSubmit();return}if(g(e,".btn_add_row_modal")){this.handleAddRowModal();return}if(g(e,".btn_inv_item_add_row")){this.handleAddInvoiceItemRow();return}let G=g(e,".btn_delete_item");if(G){this.handleDeleteSingleItem(G);return}}getCheckedInvoiceIds(){let t=[],e=document.getElementById("table-invoice");return e&&e.querySelectorAll('input[type="checkbox"]:checked').forEach(o=>{o.id&&t.push(o.id)}),t}async handleMarkAsSent(){let t=document.getElementById("btn-mark-as-sent"),e=t?.innerHTML;t&&q(t,!0);try{let n=this.getCheckedInvoiceIds(),o=`${location.origin}/invoice/inv/mark_as_sent`,s=await p(o,{keylist:n});m(s).success===1?(t&&(t.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),window.location.reload()):(t&&(t.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>'),window.location.reload())}catch(n){console.error("mark_as_sent error",n),t&&e&&q(t,!1,e),alert("An error occurred. See console for details.")}}async handleMarkSentAsDraft(){let t=document.getElementById("btn-mark-sent-as-draft"),e=t?.innerHTML;t&&q(t,!0);try{let n=this.getCheckedInvoiceIds(),o=`${location.origin}/invoice/inv/mark_sent_as_draft`,s=await p(o,{keylist:n});m(s).success===1?(t&&(t.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),window.location.reload()):(t&&(t.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>'),window.location.reload())}catch(n){console.error("mark_sent_as_draft error",n),t&&e&&q(t,!1,e),alert("An error occurred. See console for details.")}}async handleCreateRecurringMultiple(t){let e=document.querySelector(".create_recurring_confirm_multiple")||t,n=e?.innerHTML;e&&(e.innerHTML='<h6 class="text-center"><i class="fa fa-spin fa-spinner"></i></h6>',e.disabled=!0);try{let o=this.getCheckedInvoiceIds();if(o.length===0){alert("Please select invoices to create recurring invoices."),e&&n&&(e.innerHTML=n,e.disabled=!1);return}let s={keylist:o,recur_frequency:y("recur_frequency"),recur_start_date:y("recur_start_date"),recur_end_date:y("recur_end_date")};if(!s.recur_frequency||!s.recur_start_date){alert("Please select frequency and start date."),e&&n&&(e.innerHTML=n,e.disabled=!1);return}let i=`${location.origin}/invoice/invrecurring/multiple`,r=await p(i,s),l=m(r);if(l.success===1)e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),this.closeModal("create-recurring-multiple"),setTimeout(()=>{window.location.reload()},500);else{e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>');let c=l.message||"Failed to create recurring invoices. Please try again.";alert(c),e&&n&&(e.innerHTML=n,e.disabled=!1)}}catch(o){console.error("invrecurring/multiple error",o),e&&n&&(e.innerHTML=n,e.disabled=!1),alert("An error occurred while creating recurring invoices. See console for details.")}}async handleCopyMultipleInvoices(t){let e=document.querySelector(".modal_copy_inv_multiple_confirm")||t,n=e?.innerHTML;e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-spin fa-spinner"></i></h2>',e.disabled=!0);try{let o=y("modal_created_date"),s=this.getCheckedInvoiceIds();if(s.length===0){alert("Please select invoices to copy."),e&&n&&(e.innerHTML=n,e.disabled=!1);return}let i={keylist:s,modal_created_date:o},r=`${location.origin}/invoice/inv/multiplecopy`,l=await p(r,i);m(l).success===1?(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),window.location.reload()):(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>'),window.location.reload())}catch(o){console.error("multiplecopy error",o),e&&n&&(e.innerHTML=n,e.disabled=!1),alert("An error occurred. See console for details.")}}async handleAddInvoiceTax(t){let e=document.getElementById("inv_tax_submit"),n=e?.innerHTML;e&&(e.innerHTML='<i class="fa fa-spin fa-spinner"></i>',e.disabled=!0);try{let i={inv_id:new URL(location.href).pathname.split("/").at(-1)||"",inv_tax_rate_id:y("inv_tax_rate_id"),include_inv_item_tax:y("include_inv_item_tax")},r=`${location.origin}/invoice/inv/save_inv_tax_rate`,l=await p(r,i);m(l).success===1?(e&&(e.innerHTML='<i class="fa fa-check"></i>'),this.closeModal("add-inv-tax"),setTimeout(()=>{window.location.reload()},500)):(e&&(e.innerHTML='<i class="fa fa-times"></i>'),alert("Failed to add invoice tax. Please try again."),e&&n&&(e.innerHTML=n,e.disabled=!1))}catch(o){console.error("invoice tax add error",o),e&&n&&(e.innerHTML=n,e.disabled=!1),alert("An error occurred while adding invoice tax. See console for details.")}}async handleCopySingleInvoice(t){let e=document.querySelector(".inv_to_inv_confirm")||t,n=e?.innerHTML;e&&(e.innerHTML='<h6 class="text-center"><i class="fa fa-spin fa-spinner"></i></h6>',e.disabled=!0);try{let i={inv_id:new URL(location.href).pathname.split("/").at(-1)||"",client_id:y("create_inv_client_id"),user_id:y("user_id")},r=`${location.origin}/invoice/inv/inv_to_inv_confirm`,l=await p(r,i),c=m(l);c.success===1?(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),c.new_invoice_id?window.location.href=`${location.origin}/invoice/inv/view/${c.new_invoice_id}`:window.location.reload()):(e&&(e.innerHTML='<h2 class="text-center"><i class="fa fa-times"></i></h2>'),window.location.reload())}catch(o){console.error("inv_to_inv_confirm error",o),e&&n&&(e.innerHTML=n,e.disabled=!1),alert("An error occurred. See console for details.")}}async handleDeleteInvoiceItems(t){let e=document.querySelector(".delete-items-confirm-inv")||t,n=e?.innerHTML;e&&(e.innerHTML='<i class="fa fa-spin fa-spinner"></i>',e.disabled=!0);try{let o=[];document.querySelectorAll("input[name='item_ids[]']:checked").forEach(f=>{f.value&&o.push(f.value)});let r=new URL(location.href).pathname.split("/").at(-1)||"";if(o.length===0){alert("Please select items to delete."),e&&n&&(e.innerHTML=n,e.disabled=!1);return}let l={item_ids:o,inv_id:r},c=`${location.origin}/invoice/invitem/multiple`,u=await p(c,l);m(u).success===1?(e&&(e.innerHTML='<i class="fa fa-check"></i>'),this.closeModal("delete-items"),setTimeout(()=>{window.location.reload()},500)):(e&&(e.innerHTML='<i class="fa fa-times"></i>'),alert("Failed to delete items. Please try again."),e&&n&&(e.innerHTML=n,e.disabled=!1))}catch(o){console.error("delete items error",o),e&&n&&(e.innerHTML=n,e.disabled=!1),alert("An error occurred while deleting items. See console for details.")}}handlePdfExport(t){let e=t?"1":"0",n=`${location.origin}/invoice/inv/pdf/${e}`;window.open(n,"_blank")}handleModalPdfView(t){let e=t?"1":"0",n=`${location.origin}/invoice/inv/pdf/${e}`,o=document.getElementById("modal-view-inv-pdf");o&&(o.src=n);try{if(typeof window.bootstrap?.Modal<"u"){let s=document.getElementById("modal-layout-modal-pdf-inv");s&&new window.bootstrap.Modal(s).show()}}catch(s){console.warn("Failed to open PDF modal:",s)}}handleHtmlExport(t){let e=t?"1":"0",n=`${location.origin}/invoice/inv/html/${e}`;window.open(n,"_blank")}async handlePaymentSubmit(){let t=`${location.origin}/invoice/payment/add_with_ajax`,e=document.getElementById("btn_modal_payment_submit"),n=e?.innerHTML;e&&(e.innerHTML='<i class="fa fa-spin fa-spinner"></i>',e.disabled=!0);try{let o={amount:y("payment_amount"),payment_method:y("payment_method"),payment_date:y("payment_date")},s=await p(t,o);m(s).success===1?(e&&(e.innerHTML='<i class="fa fa-check"></i>'),this.closeModal("payment-modal"),setTimeout(()=>{window.location.reload()},500)):(e&&n&&(e.innerHTML=n,e.disabled=!1),alert("Failed to process payment. Please try again."))}catch(o){console.error("Payment submission error:",o),e&&n&&(e.innerHTML=n,e.disabled=!1),alert("An error occurred while processing payment. See console for details.")}}handleAddRowModal(){let e=new URL(location.href).pathname.split("/").at(-1)||"",n=`${location.origin}/invoice/invitem/add/${e}`,o=document.getElementById("modal-placeholder-invitem");o&&fetch(n,{credentials:"same-origin"}).then(s=>s.text()).then(s=>{o.textContent="";let i=document.createElement("div");i.textContent=s;let r=document.createDocumentFragment(),l=new DOMParser;try{let c=l.parseFromString(s,"text/html");if(c&&c.body){for(;c.body.firstChild;)r.appendChild(c.body.firstChild);o.appendChild(r)}}catch(c){console.error("HTML parsing error:",c),o.textContent="Error loading content"}}).catch(s=>{console.error("Failed to load modal content:",s),o.textContent="Failed to load item form. Please try again."})}handleAddInvoiceItemRow(){let t=document.getElementById("new_row"),e=document.getElementById("item_table");if(t&&e){let n=t.cloneNode(!0);n.removeAttribute("id"),n.classList.add("item"),n.style.display="block",e.appendChild(n)}}async handleDeleteSingleItem(t){let e=t.getAttribute("data-id");if(!e){let n=t.closest(".item");n&&n.remove();return}try{let n=`${location.origin}/invoice/inv/delete_item/${e}`,o=await p(n,{id:e});if(m(o).success===1){let i=t.closest(".item");i&&i.remove(),alert("Deleted"),window.location.reload()}else alert("Failed to delete item. Please try again.")}catch(n){console.error("Delete item error:",n),alert("An error occurred while deleting the item. Please try again.")}}handleSelectAllCheckboxes(t){document.querySelectorAll('input[type="checkbox"]').forEach(n=>{n.checked=t})}initializeAllClientsCheck(){this.handleAllClientsCheck()}handleAllClientsCheck(){let t=document.getElementById("user_all_clients"),e=document.getElementById("list_client");t&&e&&(t.checked?e.style.display="none":e.style.display="block")}closeModal(t){try{if(typeof window.bootstrap?.Modal<"u"){let e=document.getElementById(t);if(e){let n=window.bootstrap.Modal.getInstance(e);n&&n.hide()}}}catch(e){console.warn("Failed to close modal:",e)}}};function K(a,t){a.forEach(e=>{t?e.innerHTML='<h6 class="text-center"><i class="fa fa-spin fa-spinner"></i></h6>':e.innerHTML='<h6 class="text-center"><i class="fa fa-check"></i></h6>'})}function X(a){a.forEach(t=>{t.innerHTML='<h6 class="text-center"><i class="fa fa-error"></i></h6>'})}var A=class{constructor(){this.bindEventListeners(),this.exposeGlobalFunctions(),this.initializeComponents()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0)}handleClick(t){let e=t.target;if(e.closest("#product_filters_submit")){this.submitProductFilters(t);return}if(e.closest(".select-items-confirm-quote")){t.preventDefault(),this.handleQuoteConfirm();return}if(e.closest(".select-items-confirm-inv")){t.preventDefault(),this.handleInvoiceConfirm();return}let n=e.closest(".product");if(n&&e.tagName!=="INPUT"){let o=n.querySelector('input[type="checkbox"]');o&&o.click();return}e.matches("input[name='product_ids[]']")&&this.updateButtonStates()}initializeComponents(){typeof window.TomSelect<"u"&&document.querySelectorAll(".simple-select").forEach(t=>{t._tomselect||(new window.TomSelect(t,{}),t._tomselect=!0)}),this.updateButtonStates()}updateButtonStates(){let e=document.querySelectorAll("input[name='product_ids[]']:checked").length>0,n=document.querySelector(".select-items-confirm-quote"),o=document.querySelector(".select-items-confirm-inv");n&&(n.disabled=!e),o&&(o.disabled=!e)}filterTableBySku(){let t=document.getElementById("filter_product_sku");if(!t)return;let n=(t.value||"").toUpperCase(),o=document.getElementById("table-product");if(!o)return;let s=o.getElementsByTagName("tr");for(let i=0;i<s.length;i++){let r=s[i].getElementsByTagName("td")[2];r&&((r.textContent||r.innerText||"").toUpperCase().indexOf(n)>-1?s[i].style.display="":s[i].style.display="none")}}async submitProductFilters(t){t?.preventDefault&&t.preventDefault();let e=`${location.origin}/invoice/product/search`,n=document.querySelectorAll(".product_filters_submit");K(n,!0);try{let i={product_sku:document.getElementById("filter_product_sku")?.value||""},r=await p(e,i),l=m(r);l.success===1?(this.filterTableBySku(),this.hideSummaryBar(),K(n,!1)):(X(n),l.message&&alert(l.message))}catch(o){console.error("product search failed",o),X(n),alert("An error occurred while searching products. See console for details.")}}hideSummaryBar(){let t=document.querySelector(".mt-3.me-3.summary.text-end");t&&(t.style.visibility="hidden")}async handleQuoteConfirm(){let t=new URL(window.location.href),e=document.querySelector(".select-items-confirm-quote");this.setSecureButtonContent(e,"h2","text-center","fa fa-spin fa-spinner");let n=[],o=(t.pathname.split("/").at(-1)||"").replace(/[^0-9]/g,"");document.querySelectorAll("input[name='product_ids[]']:checked").forEach(r=>{let l=parseInt(r.value);isNaN(l)||n.push(l)});let s=n.toSorted((r,l)=>r-l);console.log("Processing products in sorted order:",s);let i=`/invoice/product/selection_quote?quote_id=${o}`;s.forEach(r=>{i+=`&product_ids[]=${r}`});try{let l=await(await fetch(i,{method:"GET",headers:{"Content-Type":"application/json; charset=utf-8","X-Requested-With":"XMLHttpRequest"}})).json();this.processProducts(l),this.setSecureButtonContent(e,"h2","text-center","fa fa-check"),window.location.reload()}catch(r){console.error("Error:",r),this.setSecureButtonContent(e,"h2","text-center","fa fa-times")}}async handleInvoiceConfirm(){let t=new URL(window.location.href),e=document.querySelector(".select-items-confirm-inv");this.setSecureButtonContent(e,"h2","text-center","fa fa-spin fa-spinner");let n=[],o=t.pathname.split("/").at(-1)||"";document.querySelectorAll("input[name='product_ids[]']:checked").forEach(r=>{let l=parseInt(r.value);isNaN(l)||n.push(l)});let s=n.toSorted((r,l)=>r-l),i=`/invoice/product/selection_inv?inv_id=${o}`;s.forEach(r=>{i+=`&product_ids[]=${r}`});try{let l=await(await fetch(i,{method:"GET",headers:{"Content-Type":"application/json; charset=utf-8","X-Requested-With":"XMLHttpRequest"}})).json();this.processProducts(l),this.setSecureButtonContent(e,"h2","text-center","fa fa-check"),window.location.reload()}catch(r){console.error("Error:",r),this.setSecureButtonContent(e,"h2","text-center","fa fa-times")}}processProducts(t){console.log("Processing",Object.keys(t).length,"products");let e=Object.groupBy(Object.entries(t).map(([n,o])=>({key:n,...o})),n=>n.tax_rate_id||"default");console.log("Products grouped by tax rate:",Object.keys(e));for(let n in t){console.log("Processing product key:",n);let o=t[n];if(!o||typeof o!="object")continue;let s=o.tax_rate_id,i;if(s)i=s;else{let l=document.getElementById("default_item_tax_rate");i=l&&l.getAttribute("value")||""}let r=document.querySelector("#item_table tbody:last-of-type");if(r){let l=r.querySelector("input[name=item_name]");l&&(l.value=o.product_name);let c=r.querySelector("textarea[name=item_description]");c&&(c.value=o.product_description);let u=r.querySelector("input[name=item_price]");u&&(u.value=o.product_price);let d=r.querySelector("input[name=item_quantity]");d&&(d.value="1");let f=r.querySelector("select[name=item_tax_rate_id]");f&&(f.value=i);let h=r.querySelector("input[name=item_product_id]");h&&(h.value=o.id);let E=r.querySelector("select[name=item_product_unit_id]");E&&(E.value=o.unit_id)}}}setSecureButtonContent(t,e,n,o){if(!t)return;for(;t.firstChild;)t.removeChild(t.firstChild);let s=document.createElement(e);n&&(s.className=n);let i=document.createElement("i");o&&(i.className=o),s.appendChild(i),t.appendChild(s)}exposeGlobalFunctions(){window.productTableFilter=this.filterTableBySku.bind(this)}};var P=class{constructor(){this.bindEventListeners(),this.initializeComponents()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0),document.addEventListener("change",this.handleChange.bind(this),!0),document.addEventListener("keydown",this.handleKeydown.bind(this),!0),document.addEventListener("shown.bs.modal",this.handleModalShown.bind(this),!0)}handleClick(t){let e=t.target;if(e.closest("#tasks_table tr, .task, .task-row")){this.rowClickToggle(t);return}let o=e.closest(".select-items-confirm-task, .select-items-confirm-task-inv, .select-items-confirm-task-quote");if(o){this.handleSelectItemsConfirmTask(o);return}if(e.closest("#task-reset-button-inv")){this.handleTaskReset();return}}handleChange(t){let e=t.target;if(e.matches("input[name='task_ids[]']")){let n=e.closest("#tasks_table")||document;this.updateSelectTaskButtonState(n)}}handleKeydown(t){if(t.key==="Enter"){let e=document.activeElement;if(e&&e.id==="filter_task_inv"){let n=document.getElementById("filter-button-inv");n&&(n.click(),t.preventDefault())}}}initializeComponents(){this.hideSelectedTasks(),this.updateSelectTaskButtonState(document)}handleModalShown(t){let e=t.target;(e.id==="modal-choose-tasks"||e.id==="modal-choose-tasks-inv")&&(console.log("Task modal shown, reinitializing components..."),this.hideSelectedTasks(),this.updateSelectTaskButtonState(document))}hideSelectedTasks(){let t=[];document.querySelectorAll(".item-task-id").forEach(o=>{let i=o.value||"";if(i.length){let r=parseInt(i,10);isNaN(r)||t.push(r)}});let e=0;document.querySelectorAll(".modal-task-id").forEach(o=>{let s=o.id||"",i=parseInt(s.replace("task-id-",""),10);if(!Number.isNaN(i)&&t.includes(i)){let r=o.closest("tr")||o.parentElement&&o.parentElement.parentElement;r&&(r.style.display="none",e++)}});let n=document.querySelectorAll(".task-row");if(e>=n.length){let o=document.getElementById("task-modal-submit");o&&(o.style.display="none")}}rowClickToggle(t){let e=t.target.closest("#tasks_table tr, .task-row, .task");if(!e)return;if(t.target.type!=="checkbox"){let o=e.querySelector('input[type="checkbox"]');o&&(o.checked=!o.checked,o.dispatchEvent(new Event("change",{bubbles:!0})))}}updateSelectTaskButtonState(t){let e=t||document,n=e.querySelectorAll("input[name='task_ids[]']"),o=e.querySelectorAll("input[name='task_ids[]']:checked"),s=o.length>0;console.log(`\u{1F50D} Task button state update: ${n.length} total checkboxes, ${o.length} checked, anyChecked: ${s}`);let i;if(i=e.querySelectorAll(".select-items-confirm-task, .select-items-confirm-task-inv, .select-items-confirm-task-quote"),i.length===0&&(i=document.querySelectorAll(".select-items-confirm-task, .select-items-confirm-task-inv, .select-items-confirm-task-quote")),i.length===0){let r=document.getElementById("task-modal-submit");r&&(i=[r],console.log("\u{1F50D} Found button by ID fallback"))}i.length===0&&document.querySelectorAll(".modal").forEach(l=>{let c=l.querySelectorAll(".select-items-confirm-task, .select-items-confirm-task-inv, #task-modal-submit");c.length>0&&(i=c,console.log("\u{1F50D} Found button in modal fallback"))}),console.log(`\u{1F50D} Found ${i.length} task submit buttons`),i.forEach(r=>{let l=r;s?(l.removeAttribute("disabled"),l.removeAttribute("aria-disabled"),l.disabled=!1,console.log("\u2705 Task submit button enabled")):(l.setAttribute("disabled","true"),l.setAttribute("aria-disabled","true"),l.disabled=!0,console.log("\u274C Task submit button disabled"))})}async handleSelectItemsConfirmTask(t){let e=new URL(location.href),n=e.pathname.split("/").at(-1)||"",o=e.pathname.includes("/quote/"),s=e.pathname.includes("/inv/"),i=Array.from(document.querySelectorAll("input[name='task_ids[]']:checked")).map(d=>parseInt(d.value,10)).filter(d=>!isNaN(d));if(i.length===0)return;let r=i.toSorted((d,f)=>d-f);console.log("Processing tasks in sorted order:",r);let l=t.innerHTML;t.innerHTML='<h2 class="text-center"><i class="fa fa-spin fa-spinner"></i></h2>',t.disabled=!0;let c=new URLSearchParams;r.forEach(d=>{c.append("task_ids[]",d.toString())}),o?c.append("quote_id",n):c.append("inv_id",n);let u=o?"selection_quote":"selection_inv";try{let d=await fetch(`/invoice/task/${u}?${c.toString()}`,{method:"GET",credentials:"same-origin",cache:"no-store",headers:{Accept:"application/json"}});if(!d.ok)throw new Error(`Network response not ok: ${d.status}`);let f=await d.text(),h;try{h=JSON.parse(f)}catch{h=f}let E=m(h);this.processTasks(E),t.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>',location.reload()}catch(d){console.error("selection_inv failed",d),t.innerHTML=l,t.disabled=!1;let f=new Error("An error occurred while adding tasks to invoice. See console for details.",{cause:d});alert(f.message)}}processTasks(t){let e=null,n=Object.groupBy(Object.entries(t).map(([o,s])=>({key:o,...s})),o=>o.tax_rate_id||"default");console.log("Tasks grouped by tax rate:",Object.keys(n)),Object.entries(t).toReversed().forEach(([o,s])=>{let i=s.tax_rate_id;if(i)e=i;else{let E=document.getElementById("default_item_tax_rate")||document.querySelector("#default_item_tax_rate");e=E?E.getAttribute("value"):""}let r=document.querySelector("#item_table tbody:last-of-type")||document.querySelector("#item_table tbody");if(!r)return;let l=r.querySelector('input[name="item_name"]'),c=r.querySelector('textarea[name="item_description"]'),u=r.querySelector('input[name="item_price"]'),d=r.querySelector('input[name="item_quantity"]'),f=r.querySelector('select[name="item_tax_rate_id"]'),h=r.querySelector('input[name="item_task_id"]');l&&(l.value=s.name||""),c&&(c.value=s.description||""),u&&(u.value=s.price||""),d&&(d.value="1"),f&&(f.value=e||""),h&&(h.value=s.id||"")})}async handleTaskReset(){let t=document.querySelector("#tasks_table");if(!t)return;let e=`${location.origin}/invoice/task/lookup?rt=true`;t.innerHTML='<h2 class="text-center"><i class="fa fa-spin fa-spinner"></i></h2>';let{promise:n,resolve:o,reject:s}=Promise.withResolvers(),i=setTimeout(()=>{s(new Error("Task lookup timeout",{cause:"Server did not respond within expected timeframe"}))},1e4);try{let l=await(await fetch(e,{cache:"no-store",credentials:"same-origin"})).text(),u=new DOMParser().parseFromString(l,"text/html"),d=document.createDocumentFragment();Array.from(u.body.children).toReversed().forEach(f=>{d.insertBefore(f,d.firstChild)}),t.innerHTML="",t.appendChild(d),this.updateSelectTaskButtonState(t),clearTimeout(i),o()}catch(r){clearTimeout(i),console.error("task lookup load failed",r),s(r)}n.then(()=>{document.querySelectorAll(".select-items-confirm-task").forEach(r=>{r.removeAttribute("disabled")})}).catch(r=>{console.error("Task reset failed:",r),document.querySelectorAll(".select-items-confirm-task").forEach(l=>{l.removeAttribute("disabled")})})}};function re(a,t){let n=new DOMParser().parseFromString(t,"text/html"),o=document.createDocumentFragment();Array.from(n.body.children).forEach(s=>o.appendChild(s)),a.innerHTML="",a.appendChild(o)}function ae(){window.location.reload()}var B=class{constructor(){this.bindEventListeners(),this.initializeOnLoad()}bindEventListeners(){document.addEventListener("click",this.handleClick.bind(this),!0)}initializeOnLoad(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.initSelects()}):this.initSelects()}handleClick(t){let e=t.target;if(e.matches("#salesorder_to_pdf_confirm_with_custom_fields")||e.closest("#salesorder_to_pdf_confirm_with_custom_fields")){this.handlePdfExport(!0);return}if(e.matches("#salesorder_to_pdf_confirm_without_custom_fields")||e.closest("#salesorder_to_pdf_confirm_without_custom_fields")){this.handlePdfExport(!1);return}if(e.matches("#so_to_invoice_confirm")||e.closest("#so_to_invoice_confirm")){this.handleSoToInvoiceConversion();return}let n=e.closest(".open-salesorder-modal");if(n){this.handleOpenModal(n);return}if(e.closest(".salesorder-save")){this.handleSaveSalesOrder();return}}initSelects(){if(typeof window.TomSelect>"u")return;document.querySelectorAll(".simple-select").forEach(e=>{if(!e._tomselect)try{new window.TomSelect(e,{}),e._tomselect=!0}catch(n){console.warn("Failed to initialize TomSelect:",n)}})}async handleOpenModal(t){let e=t.dataset.url||`${location.origin}/invoice/salesorder/modal`,n=t.dataset.target||"modal-placeholder-salesorder",o=document.getElementById(n);if(!o){console.error(`Modal target element not found: ${n}`);return}try{let i=await(await fetch(e,{cache:"no-store",credentials:"same-origin"})).text();re(o,i);let r=o.querySelector(".modal");r&&window.bootstrap?.Modal&&new window.bootstrap.Modal(r).show(),this.initSelects()}catch(s){console.error("Failed to load sales order modal:",s),alert("Failed to load modal. Please try again.")}}handlePdfExport(t){let e=location.origin+"/invoice/salesorder/pdf/"+(t?"1":"0");window.location.reload(),window.open(e,"_blank")}async handleSoToInvoiceConversion(){let t=document.querySelector(".so_to_invoice_confirm");t&&(t.innerHTML='<i class="fa fa-spin fa-spinner fa-margin"></i>');let e=document.getElementById("so_id"),n=document.getElementById("client_id"),o=document.getElementById("group_id"),s=document.getElementById("password");if(!e?.value||!n?.value||!o?.value){console.error("Required fields missing for SO to Invoice conversion"),alert("Missing required data for conversion");return}let i={so_id:e.value,client_id:n.value,group_id:o.value,password:s?.value||""};try{let r=location.origin+"/invoice/salesorder/so_to_invoice_confirm",l=await p(r,i);l&&l.success===1?(t&&(t.innerHTML='<h2 class="text-center"><i class="fa fa-check"></i></h2>'),ae()):(l?.validation_errors&&(document.querySelectorAll(".control-group").forEach(c=>{c.classList.remove("error")}),Object.entries(l.validation_errors).forEach(([c,u])=>{let d=document.getElementById(c);d?.parentElement&&d.parentElement.classList.add("has-error")})),t&&(t.innerHTML='<h6 class="text-center"><i class="fa fa-check"></i></h6>'))}catch(r){console.error("SO to Invoice conversion failed:",r),t&&(t.innerHTML='<h6 class="text-center"><i class="fa fa-check"></i></h6>'),alert("An error occurred during conversion. Please try again.")}}async handleSaveSalesOrder(){let t=document.querySelector("#salesorder_form");if(!t){console.error("Sales order form not found");return}try{let e=t.getAttribute("action")||`${location.origin}/invoice/salesorder/save`,n=new FormData(t),o=new URLSearchParams;n.forEach((c,u)=>{o.append(u,c.toString())});let s=`${e}?${o.toString()}`,r=await(await fetch(s,{cache:"no-store",credentials:"same-origin",headers:{Accept:"application/json"}})).json(),l=m(r);if(l.success===1)window.location.reload();else{let c=l.message||"Save failed";alert(c)}}catch(e){console.error("Sales order save failed:",e),alert("An error occurred while saving. Please try again.")}}};var F=class{constructor(){this.bindEventListeners()}bindEventListeners(){document.addEventListener("DOMContentLoaded",this.initializeSelectors.bind(this))}initializeSelectors(){let t=document.getElementById("family-category-primary-id"),e=document.getElementById("family-category-secondary-id");t&&(t.addEventListener("change",this.onPrimaryChange.bind(this),!1),this.initializeSelector(()=>this.onPrimaryChange())),e&&(e.addEventListener("change",this.onSecondaryChange.bind(this),!1),this.initializeSelector(()=>this.onSecondaryChange()))}initializeSelector(t){let{promise:e,resolve:n,reject:o}=Promise.withResolvers(),s=setTimeout(()=>{o(new Error("Selector initialization timeout",{cause:"DOM not ready within expected timeframe"}))},5e3);setTimeout(()=>{clearTimeout(s),n()},0),e.then(()=>t()).catch(i=>{console.error("Selector initialization failed:",i);try{t()}catch(r){console.error("Callback execution failed:",r)}})}populateSelect(t,e,n){if(!t)return;t.innerHTML="";let o=document.createElement("option");o.value="",o.textContent=n||"None",t.appendChild(o),e&&(Array.isArray(e)?e.forEach((s,i)=>{let r=document.createElement("option");r.value=i.toString(),r.textContent=s,t.appendChild(r)}):Object.entries(e).forEach(([s,i])=>{let r=document.createElement("option");r.value=s,r.textContent=i,t.appendChild(r)}))}async onPrimaryChange(){let t=document.getElementById("family-category-primary-id");if(!t)return;let e=t.value||"",n=`${location.origin}/invoice/family/secondaries/${encodeURIComponent(e)}`;try{let s=await p(n,{category_primary_id:e}),i=m(s);if(i.success===1){let r=i.secondary_categories||{},l=document.getElementById("family-category-secondary-id");if(this.populateSelect(l,r,"None"),l){let c=new Event("change",{bubbles:!0});l.dispatchEvent(c)}}else this.populateSelect(document.getElementById("family-category-secondary-id"),{},"None"),this.populateSelect(document.getElementById("family-name"),{},"None")}catch(o){console.error("Error loading secondary categories",o),this.populateSelect(document.getElementById("family-category-secondary-id"),{},"None"),this.populateSelect(document.getElementById("family-name"),{},"None")}}async onSecondaryChange(){let t=document.getElementById("family-category-secondary-id");if(!t)return;let e=t.value||"",n=`${location.origin}/invoice/family/names/${encodeURIComponent(e)}`;try{let s=await p(n,{category_secondary_id:e}),i=m(s);if(i.success===1){let r=i.family_names||{},l=document.getElementById("family-name");this.populateSelect(l,r,"None")}else this.populateSelect(document.getElementById("family-name"),{},"None")}catch(o){console.error("Error loading family names",o),this.populateSelect(document.getElementById("family-name"),{},"None")}}};var D=class{originalDisplayStyles={};originalDisabledStates={};constructor(){this.bindEventListeners()}bindEventListeners(){document.addEventListener("DOMContentLoaded",this.initialize.bind(this))}initialize(){this.toggleSmtpSettings();let t=document.getElementById("email_send_method");t&&t.addEventListener("change",this.toggleSmtpSettings.bind(this));let e=document.getElementById("btn_fph_generate");e&&e.addEventListener("click",i=>{i.preventDefault(),this.handleFphGenerateClick()});let n=document.getElementById("form-settings"),o=document.getElementById("btn-submit");o&&n&&n.contains(o)&&o.addEventListener("click",i=>{i.preventDefault(),this.handleSettingsSubmitClick()});let s=document.getElementById("online-payment-select");s&&s.addEventListener("change",this.handleOnlinePaymentSelectChange.bind(this)),this.handleOnlinePaymentSelectChange()}toggleSmtpSettings(){let t=document.getElementById("email_send_method"),e=document.getElementById("div-smtp-settings");!e||!t||(t.value==="smtp"?e.style.display="":e.style.display="none")}async handleFphGenerateClick(){let t=`${location.origin}/invoice/setting/fphgenerate`,e={userAgent:navigator.userAgent,width:window.screen.width,height:window.screen.height,scalingFactor:Math.round(window.devicePixelRatio*100)/100,colourDepth:window.screen.colorDepth,windowInnerWidth:window.innerWidth,windowInnerHeight:window.innerHeight},n=new URLSearchParams;Object.entries(e).forEach(([o,s])=>{n.append(o,s.toString())});try{let o=await fetch(`${t}?${n.toString()}`,{method:"GET",credentials:"same-origin",cache:"no-store",headers:{Accept:"application/json"}});if(!o.ok)throw new Error(`Network response not ok: ${o.status}`);let s=await o.json().catch(()=>({})),i=m(s);i.success===1&&(this.updateSettingField("settings[fph_client_browser_js_user_agent]",i.userAgent),this.updateSettingField("settings[fph_client_device_id]",i.deviceId),this.updateSettingField("settings[fph_screen_width]",i.width),this.updateSettingField("settings[fph_screen_height]",i.height),this.updateSettingField("settings[fph_screen_scaling_factor]",i.scalingFactor),this.updateSettingField("settings[fph_screen_colour_depth]",i.colourDepth),this.updateSettingField("settings[fph_timestamp]",i.timestamp),this.updateSettingField("settings[fph_window_size]",i.windowSize),this.updateSettingField("settings[fph_gov_client_user_id]",i.userUuid))}catch(o){console.error("FPH generate failed",o)}}updateSettingField(t,e){let n=document.getElementById(t);n&&e!==void 0&&(n.value=e)}handleSettingsSubmitClick(){let t=document.getElementById("form-settings");if(!t)return;let e=t.querySelectorAll(".tab-pane");this.originalDisplayStyles={},this.originalDisabledStates={},Array.from(e).toReversed().forEach(n=>{n.id&&(this.originalDisplayStyles[n.id]=n.style.display,n.style.display="block",n.querySelectorAll("input:disabled, select:disabled, textarea:disabled").forEach((s,i)=>{let r=`${n.id}_${i}`;this.originalDisabledStates[r]={element:s,disabled:!0},s.disabled=!1}))}),setTimeout(()=>{t.submit(),this.restoreFormState(e)},10)}restoreFormState(t){t.forEach(e=>{e.id&&this.originalDisplayStyles[e.id]!==void 0&&(e.style.display=this.originalDisplayStyles[e.id])}),Object.entries(this.originalDisabledStates).forEach(([e,n])=>{n.element&&n.disabled&&(n.element.disabled=!0)})}handleOnlinePaymentSelectChange(){let t=document.getElementById("online-payment-select");if(!t)return;let e=t.value;document.querySelectorAll(".gateway-settings").forEach(s=>{s.classList.contains("active-gateway")||s.classList.add("hidden")});let o=document.getElementById(`gateway-settings-${e}`);o&&(o.classList.remove("hidden"),o.classList.add("active-gateway"))}};function U(){let a=window.bootstrap;if(typeof a>"u"||!a.Tooltip)return;document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(e=>{try{new a.Tooltip(e)}catch{}})}function z(a){let t=window.TomSelect;if(typeof t>"u")return;(a||document).querySelectorAll(".simple-select").forEach(o=>{o._tomselect||(new t(o,{}),o._tomselect=!0)})}function j(){let a=document.getElementById("fullpage-loader"),t=document.getElementById("loader-error"),e=document.getElementById("loader-icon");a&&(a.style.display="block"),t&&(t.style.display="none"),e&&(e.classList.add("fa-spin"),e.classList.remove("text-danger")),setTimeout(()=>{t&&(t.style.display="block"),e&&(e.classList.remove("fa-spin"),e.classList.add("text-danger"))},1e4)}function Q(){let a=document.getElementById("fullpage-loader"),t=document.getElementById("loader-error"),e=document.getElementById("loader-icon");a&&(a.style.display="none"),t&&(t.style.display="none"),e&&(e.classList.add("fa-spin"),e.classList.remove("text-danger"))}function W(){let a=document.querySelector(".passwordmeter-input");a&&a.addEventListener("input",()=>{let t=a.value,e=le(t),n=document.querySelector(".passmeter-2"),o=document.querySelector(".passmeter-3");n&&o&&(n.style.display="none",o.style.display="none",e>=4?(n.style.display="block",o.style.display="block"):e>=3&&(n.style.display="block"))})}function le(a){let t=0;return a.length>=8&&t++,/[a-z]/.test(a)&&t++,/[A-Z]/.test(a)&&t++,/[0-9]/.test(a)&&t++,/[^A-Za-z0-9]/.test(a)&&t++,t}function ce(){document.addEventListener("DOMContentLoaded",()=>{U(),z(),W(),document.addEventListener("click",a=>{let t=a.target;t.classList.contains("ajax-loader")&&j(),t.classList.contains("fullpage-loader-close")&&Q()})})}ce();console.log("Invoice TypeScript bundle loaded");var S=class{#e;#t;#n;#o;#i;#s;#r;#a;#l;constructor(){this.#e=new k,this.#t=new I,this.#n=new C,this.#o=new R,this.#i=new A,this.#s=new P,this.#r=new B,this.#a=new F,this.#l=new D,this.initializeTooltips(),this.initializeTaggableFocus(),U(),z(),W(),this.initializeFullpageLoader(),console.log("Invoice TypeScript App initialized with all core handlers: Quote, Client, Invoice, Product, Task, SalesOrder, Family, and Settings")}initializeTooltips(){document.addEventListener("DOMContentLoaded",()=>{typeof bootstrap<"u"&&bootstrap.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(e=>{try{new bootstrap.Tooltip(e)}catch(n){console.warn("Tooltip initialization failed:",n)}})})}initializeTaggableFocus(){document.addEventListener("focus",t=>{let e=t.target;e?.classList?.contains("taggable")&&(window.lastTaggableClicked=e)},!0)}initializeFullpageLoader(){document.addEventListener("click",t=>{let e=t.target;e.classList.contains("ajax-loader")&&j(),e.classList.contains("fullpage-loader-close")&&Q()})}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>new S):new S;return oe(de);})();
